<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema ITL PEMEX - Procesador Completo</title>
    <link href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 50%, #581c87 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .success-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .field-display {
            background: rgba(59, 130, 246, 0.1);
            border-left: 4px solid #3b82f6;
        }
        .excel-button {
            background: linear-gradient(45deg, #22C55E, #16A34A);
            transition: all 0.3s ease;
        }
        .excel-button:hover {
            background: linear-gradient(45deg, #16A34A, #15803D);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(34, 197, 94, 0.3);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="text-center mb-8">
            <div class="flex justify-center items-center mb-4">
                <div class="bg-white rounded-full p-3 mr-4">
                    <svg class="w-8 h-8 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a2 2 0 00-2 2v6a2 2 0 002 2h8a2 2 0 002-2V6a2 2 0 00-2-2V3a2 2 0 012 2v6a4 4 0 01-4 4H6a4 4 0 01-4-4V5z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <h1 class="text-5xl font-bold text-white">Sistema ITL - PEMEX</h1>
            </div>
            <p class="text-white opacity-90 text-lg">Procesador Completo de Formularios ITL</p>
            <p class="text-blue-200 text-sm mt-2">‚ú® Todo en uno - Sin servidor necesario ‚ú®</p>
        </div>

        <div class="glass-effect rounded-3xl p-8 shadow-2xl mb-8">
            <div class="mb-8">
                <h2 class="text-3xl font-semibold text-white mb-6 flex items-center">
                    <span class="bg-blue-500 rounded-full p-2 mr-3">üìÅ</span>
                    Cargar y Procesar Formulario ITL
                </h2>
                <div class="bg-white bg-opacity-10 rounded-xl p-6">
                    <div class="mb-6 p-4 bg-green-500 bg-opacity-20 border border-green-500 rounded-lg">
                        <h4 class="text-green-200 font-semibold mb-2">‚úÖ Azure GPT-4o + Google Sheets Configurado</h4>
                        <p class="text-green-200 text-sm">Sistema listo para procesar PDFs y enviar autom√°ticamente a Google Sheets</p>
                        <p class="text-green-300 text-xs mt-1">Azure: cuente8n8.openai.azure.com | Sheets: Accidentes_Trabajo_2025</p>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-white text-sm font-medium mb-2">Seleccionar archivo PDF:</label>
                        <input type="file" id="pdfFile" accept=".pdf" 
                               class="block w-full text-white bg-white bg-opacity-20 rounded-lg p-4 mb-4
                                      file:mr-4 file:py-3 file:px-6 file:rounded-lg file:border-0
                                      file:text-sm file:font-semibold file:bg-blue-600 file:text-white
                                      hover:file:bg-blue-700 transition-all duration-200">
                    </div>
                    
                    <div class="grid grid-cols-1 gap-4">
                        <button id="extractButton" 
                                class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 
                                       text-white px-8 py-4 rounded-xl font-semibold text-lg transition-all duration-300 
                                       transform hover:scale-105 shadow-lg">
                            üîç Procesar Formulario ITL
                        </button>
                    </div>
                    
                    <div id="loadingSection" class="hidden mt-6 text-center">
                        <div class="loading-spinner mx-auto mb-4"></div>
                        <p class="text-white text-lg" id="loadingText">Procesando formulario...</p>
                        <p class="text-blue-200 text-sm">Esto puede tomar unos segundos</p>
                    </div>

                    <div id="status" class="mt-6 p-4 rounded-lg hidden"></div>
                </div>
            </div>
        </div>

        <div id="resultSection" class="glass-effect rounded-3xl p-8 shadow-2xl hidden">
            <h2 class="text-3xl font-semibold text-white mb-6 flex items-center">
                <span class="bg-green-500 rounded-full p-2 mr-3">‚úÖ</span>
                Datos Extra√≠dos del Formulario ITL
            </h2>
            <div id="extractedData" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8"></div>
            
            <div class="bg-white bg-opacity-10 rounded-xl p-6">
                <h3 class="text-xl font-semibold text-white mb-4">üìä Estado de los Formularios:</h3>
                <div id="processStatus" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n y variables globales
        let extractedData = null;
        let currentAccidentId = 1;

        // Configuraci√≥n de Azure OpenAI (GPT-4o)
        const AZURE_CONFIG = {
            endpoint: "https://cuente8n8.openai.azure.com/",
            apiKey: "4C0mfORSac5WlA2LXBWDXkxI6WF8f0HENRpytmkObBRMlnjLkTjaJQQJ99BEACYeBjFXJ3w3AAABACOGixsB",
            deployment: "gpt-4oromanpemex",
            apiVersion: "2024-12-01-preview"
        };

        // Configuraci√≥n de Google Sheets
        const GOOGLE_SHEETS_CONFIG = {
            SHEET_ID: "1Ytru7yH2y60sc0qMtmhEHy-fp3Y_4uvsbZRx1ZUWNG4",
            SCOPES: ["https://www.googleapis.com/auth/spreadsheets"],
            CREDENTIALS: {
                "type": "service_account",
                "project_id": "ptar-database",
                "private_key_id": "bd98552da86051d8604f6e6a771fb19fffe65f76",
                "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDCBIGmYX79ZzBG\nMU3ZRg9/V9F1Qx3aOrhjJPpAaMgrgWDacuAn3wnP/0kVGnaf3D/O+0zjcOdJcTyr\n5WhJB+Zrm2LI3vajgpoYGqcgpnzy53undMcgx07WEXUcLjqAFUPHCeDVqPGURGx/\nBtiI1BXTtIcBvbwLtH4HyvKs33NrOABdxPGEHsrpZTHHFyWs0CpFaes6IRX68Qmd\no18krm0mrxNeLQ1Vnnbu1wTwDhEY9DnyTD3MDozLp8TEYq2D649BBNAYUWQdJYgk\nIDqzVlt/VYfSOvclh4I8vbqB/Ag/WDgE4zl7hRwCkeURFvLGv4dqrGoY7zbhJ3C7\n0nvIWMx3AgMBAAECggEAAt8Hvz5GCFTPjmVHk4Qpl4zOMoFfRJajDo5ffSrM5KPt\nplJQQHPkfTymmf82fNX3W5epd2envglcGf7zQdHJPx9s+GnxvotyMvsHcvTt+FoZ\nFTul3Xtc3/4JsPSSXVTKgPDJh2ocIjX9j2oMS0yhSGz+6qnQ7KVrp4EM9g8nlPoA\nsLT+U8+DnF/dK8CZZXgQF7lAm2zhgQlc848lz3cyrp4JHug49ebhtgCVYMaEl/tE\nf4/8NvgP2+Vp0k1Y/yTtIDcV89WLfXx+v+lcCT8zJPgelmlF+z/EYRLBI69YXjeJ\n9VAswVi4KO6PYx2LHnMgCr/V/M2+9udf9eLSW153HQKBgQD3gYTe/1QG/j0zF/Oe\nOFeebl8buHh7u028bbnqa57n9KHMGRA4PMhpVj6e/B7cqxOVjyAvxIu1xhDluF8v\nI/uDx1eQhFJIl3ZsYhxtYpsvXfi5S8dzsYxULNTxCy9FabbkmeNqTDPZBA/yqsf4\n/9UAMTHmSDbeXoVAWDKNET5zRQKBgQDIrQ/X8tGpLjs6QlqrG1lV2HykyGz0l0IG\ngPrW4lTRQE7VEJEp0U9h6YcUsStZWNVw/0HzKoIOtx94aF14p2TMJhpu7l2dF3mP\nMM+c4Cb3cFLC8GfeKd1CW1dQ2lCXqVirB6tQUzKtYD6mdFEAYLByygal9el9kYFi\n8Im7bwe+iwKBgGBXNAcxT93g/KV0v0lpGQH8aFz78zoGcH3WIDYVaidT2978KooZ\nbtFB1uI/tSukE911dsvhL5iz3kPs/m/1C6QB5h3Ew9qpyljp37LcXReU9on560sn\nYz4orUKeXeog+iYFmLX5r3zbzfFhdLGBs8F9ZLUEiwcHt8qSCitK+QoZAoGABklN\nlsE3iio1lsSfXH7V1Jech/jzWNIoMlX2Bac/avKtxYToVzwEVZfgMGjAZ+MdhJWq\ndjidrGJWLQpv6yirQq3q5BC5hANJPpAT4OEwt02gehTX3CDJmpuL569/GNEoQutR\nlYmVq9K5A7PfGbjtrhrgDHDgqJtXR0cruWBoCLMCgYEAnWKQ5VCZf2hdSGX75Hpw\naT3Z8igaffnlE6/BvSr1VBJ9d+XWLnucJ+Io5Hmrb5s+Siy22FH7BHoMe7nh9jTQ\n4scbzIPK5t86s0tNd+mQM7xdAE2p1fVePB190ksB8Ujc1BAgq74RR53apoWB0Ezg\nELQB0gAtd5sJDkhSi4QrllQ=\n-----END PRIVATE KEY-----\n",
                "client_email": "ptar-database-service@ptar-database.iam.gserviceaccount.com",
                "client_id": "109923982422785398336",
                "auth_uri": "https://accounts.google.com/o/oauth2/auth",
                "token_uri": "https://oauth2.googleapis.com/token",
                "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
                "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/ptar-database-service%40ptar-database.iam.gserviceaccount.com",
                "universe_domain": "googleapis.com"
            }
        };

        // Configuraci√≥n de PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Event Listeners
        document.getElementById('extractButton').addEventListener('click', extractDataFromPDF);

        // Funci√≥n principal para extraer datos del PDF
        async function extractDataFromPDF() {
            const fileInput = document.getElementById('pdfFile');
            const loadingSection = document.getElementById('loadingSection');
            const status = document.getElementById('status');
            const resultSection = document.getElementById('resultSection');
            const loadingText = document.getElementById('loadingText');

            if (!fileInput.files.length) {
                showStatus('Por favor selecciona un archivo PDF', 'error');
                return;
            }

            try {
                loadingSection.classList.remove('hidden');
                status.classList.add('hidden');
                resultSection.classList.add('hidden');

                const file = fileInput.files[0];
                loadingText.textContent = 'Leyendo archivo PDF...';

                // M√©todo mejorado para leer PDF
                const arrayBuffer = await file.arrayBuffer();
                console.log('Tama√±o del archivo:', arrayBuffer.byteLength, 'bytes');
                
                const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                console.log('PDF cargado. P√°ginas:', pdf.numPages);
                
                let fullText = '';
                const totalPages = pdf.numPages;

                // Extraer texto de todas las p√°ginas con mejor manejo
                for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
                    try {
                        loadingText.textContent = `Procesando p√°gina ${pageNum} de ${totalPages}...`;
                        const page = await pdf.getPage(pageNum);
                        
                        // M√©todo principal de extracci√≥n de texto
                        const textContent = await page.getTextContent();
                        console.log(`P√°gina ${pageNum} - Items de texto encontrados:`, textContent.items.length);
                        
                        // Extraer texto con mejor formateo
                        let pageText = '';
                        let lastY = null;
                        
                        textContent.items.forEach((item, index) => {
                            // Agregar salto de l√≠nea si cambia la posici√≥n Y significativamente
                            if (lastY !== null && Math.abs(item.transform[5] - lastY) > 5) {
                                pageText += '\n';
                            }
                            
                            pageText += item.str;
                            
                            // Agregar espacio si el siguiente elemento est√° separado horizontalmente
                            if (index < textContent.items.length - 1) {
                                const nextItem = textContent.items[index + 1];
                                const currentX = item.transform[4] + item.width;
                                const nextX = nextItem.transform[4];
                                
                                if (nextX - currentX > 5) {
                                    pageText += ' ';
                                }
                            }
                            
                            lastY = item.transform[5];
                        });
                        
                        console.log(`P√°gina ${pageNum} texto extra√≠do (primeros 200 chars):`, pageText.substring(0, 200));
                        fullText += pageText + '\n\n';
                        
                    } catch (pageError) {
                        console.error(`Error procesando p√°gina ${pageNum}:`, pageError);
                    }
                }

                console.log('Texto completo extra√≠do (length):', fullText.length);
                console.log('Texto completo (primeros 500 chars):', fullText.substring(0, 500));

                if (!fullText.trim()) {
                    console.log('üñºÔ∏è PDF es una imagen escaneada - Usando Azure GPT-4o Vision...');
                    loadingText.textContent = 'PDF escaneado detectado - Procesando con Azure GPT-4o...';
                    
                    // Procesar con Azure GPT-4o Vision
                    extractedData = await processWithAzureGPT4o(pdf);
                    
                    if (Object.keys(extractedData).length === 0) {
                        throw new Error('No se pudieron extraer datos con Azure GPT-4o. Revisa la conexi√≥n.');
                    }
                    
                } else {
                    // Procesar texto extra√≠do normalmente
                    loadingText.textContent = 'Extrayendo datos con IA avanzada...';
                    extractedData = extractDataWithAdvancedPatterns(fullText);
                }
                
                // Si no se encontraron datos, intentar con patrones m√°s simples
                if (Object.keys(extractedData).length === 0) {
                    console.log('Intentando con patrones de fallback...');
                    extractedData = extractWithSimplePatterns(fullText);
                }
                
                // Generar ID de accidente
                currentAccidentId = Math.floor(Math.random() * 9000) + 1000;
                extractedData.ID_Accidente = currentAccidentId;

                // Mostrar resultados
                displayResults(extractedData);
                showStatus('‚úÖ Formulario ITL procesado y enviado a Google Sheets exitosamente', 'success');
                
                // Enviar autom√°ticamente a Google Sheets
                loadingText.textContent = 'Enviando datos a Google Sheets...';
                
                const sheetsResult = await sendToGoogleSheets(extractedData);
                if (sheetsResult) {
                    showStatus('‚úÖ Formulario procesado y enviado a Google Sheets exitosamente', 'success');
                } else {
                    showStatus('‚úÖ Formulario procesado exitosamente (Google Sheets no disponible)', 'success');
                }

            } catch (error) {
                console.error('Error completo:', error);
                showStatus(`‚ùå Error al procesar: ${error.message}`, 'error');
                
                // Intentar m√©todo alternativo si falla
                if (error.message.includes('imagen escaneada')) {
                    showStatus('üì∏ Detectado PDF escaneado. Implementando OCR...', 'info');
                }
            } finally {
                loadingSection.classList.add('hidden');
            }
        }

        // Funci√≥n para convertir PDF a im√°genes y procesar con Azure GPT-4o
        async function processWithAzureGPT4o(pdf) {
            const extractedData = {};
            
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                try {
                    console.log(`üîç Procesando p√°gina ${pageNum} con Azure GPT-4o...`);
                    
                    // Convertir p√°gina a imagen de alta calidad
                    const page = await pdf.getPage(pageNum);
                    const viewport = page.getViewport({ scale: 3.0 }); // M√°xima resoluci√≥n para mejor OCR
                    
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    await page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise;

                    // Convertir canvas a base64
                    const imageData = canvas.toDataURL('image/png').split(',')[1];
                    console.log(`üì∏ Imagen de p√°gina ${pageNum} convertida (${imageData.length} chars)`);
                    
                    // Llamar a Azure GPT-4o
                    const pageData = await callAzureOpenAI(imageData, pageNum);
                    
                    // Fusionar datos extra√≠dos con l√≥gica inteligente (no sobrescribir valores v√°lidos)
                    const flattenedData = flattenAzureResponse(pageData, pageNum);
                    
                    // Fusi√≥n inteligente: mantener el valor m√°s completo
                    for (const [key, value] of Object.entries(flattenedData)) {
                        if (!extractedData[key] || 
                            extractedData[key].length < value.length || 
                            extractedData[key] === 'Se anexa relato' ||
                            extractedData[key] === 'No visible en la imagen.' ||
                            extractedData[key] === 'Lic. Pada 02/05/25 atenci√≥n') {
                            extractedData[key] = value;
                            console.log(`üîÑ Actualizando ${key} con valor m√°s completo:`, value.substring(0, 100) + (value.length > 100 ? '...' : ''));
                        }
                    }
                    
                } catch (error) {
                    console.error(`‚ùå Error procesando p√°gina ${pageNum}:`, error);
                }
            }
            
            console.log('üéØ Datos finales extra√≠dos con Azure GPT-4o:', extractedData);
            console.log('üéØ Relato_Hechos final:', extractedData.Relato_Hechos);
            console.log('üéØ Relato_Medico final:', extractedData.Relato_Medico);
            return extractedData;
        }

        // Funci√≥n para generar interpretaci√≥n de calificaci√≥n IA seg√∫n DTO-PACH-RL-03
        function generateCalificacionIA(data) {
            console.log('ü§ñ Generando interpretaci√≥n de calificaci√≥n IA...');
            
            // Verificar presencia de cada ITL
            const hasITL1 = data.Relato_Hechos && data.Relato_Hechos !== 'Se anexa relato' && data.Relato_Hechos.length > 20;
            const hasITL2 = (data.Relato_Medico && data.Relato_Medico.length > 10) || (data.Medico && data.Diagnostico);
            const hasITL3 = data.Condiciones_Inseguras || data.Actos_Inseguros;
            const hasITL4 = data.Calificacion_Accidente && 
                            data.Calificacion_Accidente !== 'Pendiente calificaci√≥n' && 
                            data.Calificacion_Accidente !== 'Sin datos' &&
                            data.Calificacion_Accidente.trim() !== '';
            const hasITL5 = data.Costo_Total || data.Tipo_Incapacidad;
            const hasITLT = data.Lugar_Accidente && data.Relato_Hechos;
            
            let interpretacion = '';
            let traslado_info = '';
            
            // Determinar si es accidente de traslado
            if (hasITLT || (data.Es_Traslado && data.Es_Traslado.toLowerCase().includes('s√≠'))) {
                traslado_info = ' (Accidente reportado como de traslado/trayecto)';
            }
            
            // L√ìGICA JER√ÅRQUICA seg√∫n DTO-PACH-RL-03
            
            // 1. PRIORIDAD 1: Calificaci√≥n oficial presente (ITL-4)
            if (hasITL4) {
                const calificacion = data.Calificacion_Accidente.toUpperCase();
                const fundamento = data.Fundamento_Legal || 'Pendiente an√°lisis legal';
                const observaciones = data.Observaciones || 'Ninguna';
                
                if (calificacion.includes('S√ç DE TRABAJO') || calificacion.includes('SI DE TRABAJO')) {
                    interpretacion = `Calificaci√≥n Oficial PEMEX: S√ç DE TRABAJO. Fundamento: ${fundamento}. Observaciones: ${observaciones}`;
                } else if (calificacion.includes('NO DE TRABAJO')) {
                    interpretacion = `Calificaci√≥n Oficial PEMEX: NO DE TRABAJO. Fundamento: ${fundamento}. Observaciones: ${observaciones}`;
                } else {
                    interpretacion = `Calificaci√≥n Oficial PEMEX: ${calificacion}. Fundamento: ${fundamento}. Observaciones: ${observaciones}`;
                }
                interpretacion += traslado_info;
                
            // 2. PRIORIDAD 2: Informaci√≥n base completa (ITL 1, 2, 3) sin calificaci√≥n oficial
            } else if (hasITL1 && hasITL2 && hasITL3) {
                interpretacion = 'Informaci√≥n base completa (ITL-1, ITL-2, ITL-3) para an√°lisis inicial. Los datos sugieren un posible accidente de trabajo, pero la calificaci√≥n oficial (ITL-4) est√° pendiente';
                if (hasITLT) {
                    interpretacion += '. (Reportado como posible accidente de traslado/trayecto)';
                } else {
                    interpretacion += '.';
                }
                
            // 3. PRIORIDAD 3: Informaci√≥n incompleta
            } else {
                const faltantes = [];
                if (!hasITL1) faltantes.push('ITL-1');
                if (!hasITL2) faltantes.push('ITL-2');
                if (!hasITL3) faltantes.push('ITL-3');
                
                interpretacion = `Informaci√≥n base incompleta (Faltan: ${faltantes.join(', ')}). PEMEX calificar√° con elementos disponibles seg√∫n Art. 3 DTO-PACH-RL-03. Calificaci√≥n oficial (ITL-4) pendiente`;
                if (hasITLT) {
                    interpretacion += '. (Reportado como posible accidente de traslado/trayecto con informaci√≥n incompleta)';
                } else {
                    interpretacion += '.';
                }
            }
            
            // Informaci√≥n adicional sobre ITL-5 si est√° presente
            if (hasITL5) {
                interpretacion += ` [ITL-5 presente: expediente completo con costos m√©dicos]`;
            }
            
            console.log('ü§ñ Interpretaci√≥n IA generada:', interpretacion);
            return interpretacion;
        }

        // Funci√≥n para aplanar la respuesta anidada de Azure GPT-4o
        function flattenAzureResponse(azureData, pageNum) {
            const flatData = {};
            
            console.log(`üìã Procesando respuesta de p√°gina ${pageNum}:`, azureData);
            
            // Funci√≥n recursiva para aplanar objetos anidados
            function flattenObject(obj, prefix = '') {
                for (const [key, value] of Object.entries(obj)) {
                    if (value && typeof value === 'object' && !Array.isArray(value)) {
                        flattenObject(value, prefix);
                    } else if (value && 
                              value !== 'Campo vac√≠o' && 
                              value !== 'Texto manuscrito no legible' &&
                              value !== 'No visible en la imagen.' &&
                              value !== 'Se anexa relato' &&
                              value !== '' &&
                              String(value).trim().length > 0) {
                        // Mapear keys comunes a formato est√°ndar
                        const mappedKey = mapFieldName(key);
                        if (mappedKey) {
                            flatData[mappedKey] = String(value).trim();
                            console.log(`‚úÖ Campo mapeado: ${key} -> ${mappedKey} = ${value}`);
                        }
                    }
                }
            }
            
            // Mapeo directo de campos espec√≠ficos encontrados en la respuesta
            const directMappings = {
                // Informaci√≥n b√°sica
                'ficha_del_trabajador': 'Ficha',
                'ficha_trabajador': 'Ficha', 
                'ficha': 'Ficha',
                'nombre_completo_del_trabajador': 'Nombre',
                'nombre_trabajador': 'Nombre',
                'nombre': 'Nombre',
                'fecha_y_hora_del_accidente_lesion': 'Fecha_Incidente',
                'fecha_hora_accidente': 'Fecha_Incidente',
                'fecha_incidente': 'Fecha_Incidente',
                'centro_de_trabajo': 'Centro_Trabajo',
                'centro_trabajo': 'Centro_Trabajo',
                'departamento': 'Departamento',
                'categoria_puesto': 'Categoria',
                'categoria': 'Categoria',
                'clave_del_centro': 'Clave_Centro',
                'clave_centro': 'Clave_Centro',
                
                // ITL-1
                'relato_completo_de_como_ocurrio_la_lesion': 'Relato_Hechos',
                'relato_lesion': 'Relato_Hechos',
                'relato_hechos': 'Relato_Hechos',
                'relato': 'Relato_Hechos',
                
                // ITL-2
                'descripcion_medica_detallada_del_mecanismo_de_lesion': 'Relato_Medico',
                'Descripci√≥n_m√©dica_detallada_del_mecanismo_de_lesi√≥n': 'Relato_Medico',
                'relato_medico': 'Relato_Medico',
                'descripcion_medica': 'Relato_Medico',
                'nombre_del_medico_tratante': 'Medico',
                'Nombre_del_m√©dico_tratante': 'Medico',
                'medico': 'Medico',
                'diagnostico_medico_con_codigos_cie_10': 'Diagnostico',
                'Diagn√≥stico_m√©dico_con_c√≥digos_CIE-10': 'Diagnostico',
                'diagnostico': 'Diagnostico',
                'fecha_y_hora_de_atencion_medica': 'Fecha_Atencion',
                'Fecha_y_hora_de_atenci√≥n_m√©dica': 'Fecha_Atencion',
                'fecha_atencion': 'Fecha_Atencion',
                'unidad_medica_que_emite_el_documento': 'Unidad_Medica',
                'Unidad_m√©dica_que_emite_el_documento': 'Unidad_Medica',
                'unidad_medica': 'Unidad_Medica',
                
                // ITL-3
                'condiciones_inseguras_identificadas': 'Condiciones_Inseguras',
                'condiciones_inseguras': 'Condiciones_Inseguras',
                'actos_inseguros': 'Actos_Inseguros',
                'causa_directa_o_factor_preponderante': 'Condiciones_Inseguras',
                'Causa_directa_o_factor_preponderante': 'Condiciones_Inseguras',
                
                // ITL-4 (NUEVOS)
                'calificacion_accidente': 'Calificacion_Accidente',
                'calificacion_del_accidente': 'Calificacion_Accidente',
                'fundamento_legal': 'Fundamento_Legal',
                'base_legal': 'Fundamento_Legal',
                'formatos_considerados': 'Formatos_Considerados',
                'formatos_institucionales': 'Formatos_Considerados',
                'observaciones': 'Observaciones',
                'observaciones_calificacion': 'Observaciones',
                'fecha_calificacion': 'Fecha_Calificacion',
                'responsable_calificacion': 'Responsable_Calificacion',
                
                // ITL-5 (NUEVOS)
                'costo_total': 'Costo_Total',
                'costo_atencion_medica': 'Costo_Total',
                'tipo_incapacidad': 'Tipo_Incapacidad',
                'incapacidad': 'Tipo_Incapacidad',
                'dias_incapacidad': 'Dias_Incapacidad',
                'dias_de_incapacidad': 'Dias_Incapacidad',
                'fecha_alta': 'Fecha_Alta',
                'fecha_de_alta': 'Fecha_Alta',
                'responsable_costos': 'Responsable_Costos',
                'responsable_servicio_medico': 'Responsable_Costos',
                
                // ITL-T (NUEVOS)
                'lugar_accidente': 'Lugar_Accidente',
                'lugar_del_accidente': 'Lugar_Accidente',
                'domicilio_trabajador': 'Domicilio_Trabajador',
                'domicilio_del_trabajador': 'Domicilio_Trabajador',
                'documentos_probatorios': 'Documentos_Probatorios',
                'documentos_que_comprueban': 'Documentos_Probatorios',
                'es_traslado': 'Es_Traslado',
                'accidente_traslado': 'Es_Traslado'
            };
            
            // Aplicar mapeos directos
            flattenObject(azureData);
            
            // Buscar en mapeos directos
            for (const [azureKey, standardKey] of Object.entries(directMappings)) {
                const value = findNestedValue(azureData, azureKey);
                if (value && 
                    value !== 'Campo vac√≠o' && 
                    value !== 'Texto manuscrito no legible' &&
                    value !== 'No visible en la imagen.' &&
                    value !== 'Se anexa relato' &&
                    value !== 'Lic. Pada 02/05/25 atenci√≥n' &&
                    value !== '' &&
                    String(value).trim().length > 0) {
                    flatData[standardKey] = String(value).trim();
                    console.log(`‚úÖ Mapeo directo: ${azureKey} -> ${standardKey} = ${value}`);
                }
            }
            
            return flatData;
        }
        
        // Funci√≥n para buscar valores en objetos anidados
        function findNestedValue(obj, searchKey) {
            if (!obj || typeof obj !== 'object') return null;
            
            for (const [key, value] of Object.entries(obj)) {
                if (key.toLowerCase() === searchKey.toLowerCase()) {
                    return value;
                }
                if (typeof value === 'object' && value !== null) {
                    const found = findNestedValue(value, searchKey);
                    if (found) return found;
                }
            }
            return null;
        }
        
        // Funci√≥n para mapear nombres de campos
        function mapFieldName(key) {
            const mappings = {
                'ficha': 'Ficha',
                'ficha_del_trabajador': 'Ficha',
                'ficha_trabajador': 'Ficha',
                'nombre': 'Nombre',
                'nombre_completo': 'Nombre',
                'nombre_trabajador': 'Nombre',
                'fecha_incidente': 'Fecha_Incidente',
                'fecha_accidente': 'Fecha_Incidente',
                'centro_trabajo': 'Centro_Trabajo',
                'departamento': 'Departamento',
                'categoria': 'Categoria',
                'clave_centro': 'Clave_Centro',
                'relato': 'Relato_Hechos',
                'relato_hechos': 'Relato_Hechos',
                'relato_medico': 'Relato_Medico',
                'medico': 'Medico',
                'diagnostico': 'Diagnostico',
                'condiciones_inseguras': 'Condiciones_Inseguras',
                'actos_inseguros': 'Actos_Inseguros',
                'unidad_medica': 'Unidad_Medica',
                'fecha_atencion': 'Fecha_Atencion',
                // ITL-4 nuevos campos
                'calificacion_accidente': 'Calificacion_Accidente',
                'fundamento_legal': 'Fundamento_Legal',
                'formatos_considerados': 'Formatos_Considerados',
                'observaciones': 'Observaciones',
                'fecha_calificacion': 'Fecha_Calificacion',
                'responsable_calificacion': 'Responsable_Calificacion',
                // ITL-5 nuevos campos
                'costo_total': 'Costo_Total',
                'tipo_incapacidad': 'Tipo_Incapacidad',
                'dias_incapacidad': 'Dias_Incapacidad',
                'fecha_alta': 'Fecha_Alta',
                'responsable_costos': 'Responsable_Costos',
                // ITL-T nuevos campos
                'lugar_accidente': 'Lugar_Accidente',
                'domicilio_trabajador': 'Domicilio_Trabajador',
                'documentos_probatorios': 'Documentos_Probatorios',
                'es_traslado': 'Es_Traslado'
            };
            
            const lowerKey = key.toLowerCase();
            return mappings[lowerKey] || null;
        }

        // Funci√≥n para llamar a Azure OpenAI GPT-4o Vision
        async function callAzureOpenAI(imageBase64, pageNum) {
            const prompt = `
Eres un experto extrayendo datos de formularios ITL de PEMEX. Analiza esta imagen y extrae TODA la informaci√≥n visible, especialmente el texto manuscrito (escrito a mano).

EXTRAE ESTOS CAMPOS ESPEC√çFICOS (usa estos nombres exactos):

DATOS B√ÅSICOS:
- Ficha: n√∫mero de empleado (como 349201, 318251)
- Nombre: nombre completo del trabajador
- Fecha_Incidente: fecha y hora completa del accidente
- Centro_Trabajo: centro de trabajo completo
- Departamento: departamento o √°rea de adscripci√≥n
- Categoria: categor√≠a o puesto del trabajador
- Clave_Centro: clave del centro (como 2001)

ITL-1 (INFORME DE TRABAJADOR):
- Relato_Hechos: relato completo de c√≥mo ocurri√≥ la lesi√≥n (texto largo, incluye manuscrito)

ITL-2 (CONDICI√ìN TRABAJADOR):
- Relato_Medico: descripci√≥n m√©dica detallada (texto largo m√©dico)
- Medico: nombre completo del m√©dico tratante
- Fecha_Atencion: fecha y hora de atenci√≥n m√©dica
- Diagnostico: diagn√≥stico con c√≥digos CIE-10
- Unidad_Medica: unidad m√©dica que emite

ITL-3 (REPORTE SEGURIDAD):
- Condiciones_Inseguras: condiciones inseguras identificadas
- Actos_Inseguros: actos inseguros identificados

ITL-4 (CALIFICACI√ìN ACCIDENTE):
- Calificacion_Accidente: "S√ç DE TRABAJO" o "NO DE TRABAJO"
- Fundamento_Legal: cl√°usulas o art√≠culos legales (ej: "Cl√°u. 115 y 123 C.C.T.")
- Formatos_Considerados: formularios considerados (ej: "ITL-1, ITL-2, ITL-3")
- Observaciones: observaciones de la calificaci√≥n
- Fecha_Calificacion: fecha de la calificaci√≥n
- Responsable_Calificacion: nombre del responsable

ITL-5 (COSTOS ATENCI√ìN M√âDICA):
- Costo_Total: costo total de atenci√≥n m√©dica (ej: "$2,558.00")
- Tipo_Incapacidad: "Temporal", "Permanente parcial", "Permanente total", "Muerte"
- Dias_Incapacidad: n√∫mero de d√≠as de incapacidad
- Fecha_Alta: fecha de alta m√©dica
- Responsable_Costos: responsable del servicio m√©dico

ITL-T (TRASLADO):
- Lugar_Accidente: lugar espec√≠fico del accidente durante traslado
- Domicilio_Trabajador: domicilio del trabajador
- Documentos_Probatorios: documentos que comprueban la lesi√≥n
- Es_Traslado: "S√ç" si es accidente de traslado

INSTRUCCIONES CR√çTICAS:
1. Lee TODO el texto impreso Y manuscrito (escrito a mano)
2. Para campos de texto largo, incluye TODO el contenido encontrado
3. Si un campo est√° vac√≠o o no visible, NO lo incluyas en la respuesta
4. Lee fechas completas con formato exacto
5. Para relatos largos, incluye TODO el texto sin truncar
6. Identifica el tipo de formulario ITL presente en la imagen

RESPONDE SOLO con un JSON PLANO (sin objetos anidados) usando exactamente los nombres de campo que especifiqu√©:

{
  "Ficha": "valor encontrado",
  "Nombre": "valor encontrado",
  "Calificacion_Accidente": "S√ç DE TRABAJO",
  "Costo_Total": "$2,558.00"
}
            `;

            try {
                const url = `${AZURE_CONFIG.endpoint}/openai/deployments/${AZURE_CONFIG.deployment}/chat/completions?api-version=${AZURE_CONFIG.apiVersion}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'api-key': AZURE_CONFIG.apiKey
                    },
                    body: JSON.stringify({
                        messages: [
                            {
                                role: 'user',
                                content: [
                                    {
                                        type: 'text',
                                        text: prompt
                                    },
                                    {
                                        type: 'image_url',
                                        image_url: {
                                            url: `data:image/png;base64,${imageBase64}`
                                        }
                                    }
                                ]
                            }
                        ],
                        max_tokens: 3000,
                        temperature: 0.1
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Azure OpenAI Error: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                const content = result.choices[0].message.content;
                console.log(`üìÑ Respuesta de Azure GPT-4o para p√°gina ${pageNum}:`, content);
                
                // Extraer JSON del contenido
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const jsonData = JSON.parse(jsonMatch[0]);
                    console.log(`‚úÖ Datos extra√≠dos de p√°gina ${pageNum} con Azure GPT-4o:`, jsonData);
                    return jsonData;
                } else {
                    console.error('No se encontr√≥ JSON v√°lido en la respuesta de Azure GPT-4o');
                    // Intentar parsear todo el contenido como JSON
                    try {
                        const directJson = JSON.parse(content);
                        return directJson;
                    } catch {
                        console.error('Contenido no es JSON v√°lido:', content);
                        return {};
                    }
                }

            } catch (error) {
                console.error(`Error llamando a Azure OpenAI GPT-4o para p√°gina ${pageNum}:`, error);
                return {};
            }
        }

        // Funci√≥n alternativa usando Google Apps Script como proxy
        async function sendToGoogleSheets(data) {
            try {
                console.log('üìä Enviando datos a Google Sheets...');
                
                // Funci√≥n helper para obtener valor seguro
                const getValueSafe = (key, defaultValue = 'Sin datos') => {
                    const value = data[key];
                    return (value && String(value).trim() !== '') ? String(value).trim() : defaultValue;
                };

                // Determinar estados de cada ITL
                const hasITL1 = data.Relato_Hechos && data.Relato_Hechos !== 'Se anexa relato' && data.Relato_Hechos.length > 20;
                const hasITL2 = (data.Relato_Medico && data.Relato_Medico.length > 10) || (data.Medico && data.Diagnostico);
                const hasITL3 = data.Condiciones_Inseguras || data.Actos_Inseguros;
                const hasITL4 = data.Calificacion_Accidente && data.Fundamento_Legal;
                const hasITL5 = data.Costo_Total || data.Tipo_Incapacidad;
                const hasITLT = data.Lugar_Accidente && data.Relato_Hechos;

                // Preparar datos para cada hoja
                const sheetsData = {
                    // Hoja Accidentes_Trabajo (ACTUALIZADA)
                    'Accidentes_Trabajo': {
                        headers: ['ID_Accidente', 'Ficha_Trabajador', 'Nombre_Trabajador', 'Fecha_Incidente', 
                                'Tipo_Accidente', 'Centro_Trabajo', 'Departamento', 'Categoria', 
                                'Calificacion_Accidente', 'Costo_Total', 'Tipo_Incapacidad', 'Es_Traslado',
                                'Estatus_Accidente', 'Fecha_Registro'],
                        data: [
                            getValueSafe('ID_Accidente'),
                            getValueSafe('Ficha'),
                            getValueSafe('Nombre'),
                            getValueSafe('Fecha_Incidente', new Date().toLocaleDateString()),
                            getValueSafe('Tipo_Accidente', 'De Trabajo'),
                            getValueSafe('Centro_Trabajo'),
                            getValueSafe('Departamento'),
                            getValueSafe('Categoria'),
                            getValueSafe('Calificacion_Accidente', 'Pendiente'),
                            getValueSafe('Costo_Total', 'Pendiente'),
                            getValueSafe('Tipo_Incapacidad', 'Pendiente'),
                            hasITLT ? 'S√ç' : 'NO',
                            'En Proceso',
                            new Date().toLocaleDateString()
                        ]
                    },
                    
                    // Hoja ITL_1_Informe_Trabajador
                    'ITL_1_Informe_Trabajador': {
                        headers: ['ID_ITL1', 'ID_Accidente', 'Relato_Hechos', 'Fecha_Entrega', 'Estado'],
                        data: [
                            getValueSafe('ID_Accidente'),
                            getValueSafe('ID_Accidente'),
                            hasITL1 ? getValueSafe('Relato_Hechos') : 'Pendiente de captura',
                            hasITL1 ? new Date().toLocaleDateString() : '',
                            hasITL1 ? 'Completado' : 'Pendiente'
                        ]
                    },
                    
                    // Hoja ITL_2_Condicion_Trabajador
                    'ITL_2_Condicion_Trabajador': {
                        headers: ['ID_ITL2', 'ID_Accidente', 'Relato_Medico', 'Medico', 'Diagnostico', 
                                'Unidad_Medica', 'Fecha_Atencion', 'Estado'],
                        data: [
                            getValueSafe('ID_Accidente'),
                            getValueSafe('ID_Accidente'),
                            hasITL2 ? getValueSafe('Relato_Medico', 'Evaluaci√≥n m√©dica realizada') : 'Pendiente evaluaci√≥n m√©dica',
                            getValueSafe('Medico', 'Por asignar'),
                            getValueSafe('Diagnostico', 'Pendiente'),
                            getValueSafe('Unidad_Medica', 'Por determinar'),
                            getValueSafe('Fecha_Atencion', ''),
                            hasITL2 ? 'Completado' : 'Pendiente'
                        ]
                    },
                    
                    // Hoja ITL_3_Reporte_Seguridad
                    'ITL_3_Reporte_Seguridad': {
                        headers: ['ID_ITL3', 'ID_Accidente', 'Condiciones_Inseguras', 'Actos_Inseguros', 
                                'Fecha_Entrega', 'Estado'],
                        data: [
                            getValueSafe('ID_Accidente'),
                            getValueSafe('ID_Accidente'),
                            getValueSafe('Condiciones_Inseguras', 'Por evaluar'),
                            getValueSafe('Actos_Inseguros', 'Por evaluar'),
                            hasITL3 ? new Date().toLocaleDateString() : '',
                            hasITL3 ? 'Completado' : 'Pendiente'
                        ]
                    },

                    // Hoja ITL_4_Calificacion_Accidente (NUEVA)
                    'ITL_4_Calificacion_Accidente': {
                        headers: ['ID_ITL4', 'ID_Accidente', 'Calificacion_Accidente', 'Fundamento_Legal', 
                                'Formatos_Considerados', 'Observaciones', 'Fecha_Calificacion', 
                                'Responsable_Calificacion', 'Estado'],
                        data: [
                            getValueSafe('ID_Accidente'),
                            getValueSafe('ID_Accidente'),
                            getValueSafe('Calificacion_Accidente', 'Pendiente calificaci√≥n'),
                            getValueSafe('Fundamento_Legal', 'Pendiente an√°lisis'),
                            getValueSafe('Formatos_Considerados', 'Por determinar'),
                            getValueSafe('Observaciones', 'Sin observaciones'),
                            getValueSafe('Fecha_Calificacion', ''),
                            getValueSafe('Responsable_Calificacion', 'Por asignar'),
                            hasITL4 ? 'Completado' : 'Pendiente'
                        ]
                    },

                    // Hoja ITL_5_Costos_Atencion (NUEVA)
                    'ITL_5_Costos_Atencion': {
                        headers: ['ID_ITL5', 'ID_Accidente', 'Costo_Total', 'Tipo_Incapacidad', 
                                'Dias_Incapacidad', 'Fecha_Alta', 'Responsable_Costos', 'Estado'],
                        data: [
                            getValueSafe('ID_Accidente'),
                            getValueSafe('ID_Accidente'),
                            getValueSafe('Costo_Total', 'Pendiente c√°lculo'),
                            getValueSafe('Tipo_Incapacidad', 'Por determinar'),
                            getValueSafe('Dias_Incapacidad', '0'),
                            getValueSafe('Fecha_Alta', ''),
                            getValueSafe('Responsable_Costos', 'Por asignar'),
                            hasITL5 ? 'Completado' : 'Pendiente'
                        ]
                    },

                    // Hoja ITL_T_Traslado (NUEVA)
                    'ITL_T_Traslado': {
                        headers: ['ID_ITLT', 'ID_Accidente', 'Lugar_Accidente', 'Fecha_Incidente', 
                                'Domicilio_Trabajador', 'Relato_Hechos', 'Unidad_Medica', 
                                'Documentos_Probatorios', 'Fecha_Entrega', 'Estado'],
                        data: [
                            getValueSafe('ID_Accidente'),
                            getValueSafe('ID_Accidente'),
                            getValueSafe('Lugar_Accidente', 'Por determinar'),
                            getValueSafe('Fecha_Incidente', new Date().toLocaleDateString()),
                            getValueSafe('Domicilio_Trabajador', 'Por capturar'),
                            hasITLT ? getValueSafe('Relato_Hechos') : 'Pendiente de captura',
                            getValueSafe('Unidad_Medica', 'Por determinar'),
                            getValueSafe('Documentos_Probatorios', 'Por entregar'),
                            hasITLT ? new Date().toLocaleDateString() : '',
                            hasITLT ? 'Completado' : 'Pendiente'
                        ]
                    },
                    
                    // Hoja Resumen (ACTUALIZADA con IA)
                    'Resumen': {
                        headers: ['ID_Accidente', 'Ficha_Trabajador', 'Nombre', 'Fecha_Incidente', 
                                'Tipo_Accidente', 'ITL_1', 'ITL_2', 'ITL_3', 'ITL_4', 'ITL_5', 'ITL_T',
                                'Estado_General', 'Puntuacion_Completitud', 'Estatus_Calificacion_IA', 'Fecha_Procesamiento'],
                        data: (() => {
                            const completionScore = [
                                hasITL1 ? 1 : 0,
                                hasITL2 ? 1 : 0,
                                hasITL3 ? 1 : 0,
                                hasITL4 ? 1 : 0,
                                hasITL5 ? 1 : 0,
                                hasITLT ? 1 : 0
                            ].reduce((a, b) => a + b, 0);
                            
                            // Generar interpretaci√≥n IA
                            const calificacionIA = generateCalificacionIA(data);
                            
                            return [
                                getValueSafe('ID_Accidente'),
                                getValueSafe('Ficha'),
                                getValueSafe('Nombre'),
                                getValueSafe('Fecha_Incidente', new Date().toLocaleDateString()),
                                getValueSafe('Tipo_Accidente', 'De Trabajo'),
                                hasITL1 ? 'Completado' : 'Pendiente',
                                hasITL2 ? 'Completado' : 'Pendiente',
                                hasITL3 ? 'Completado' : 'Pendiente',
                                hasITL4 ? 'Completado' : 'Pendiente',
                                hasITL5 ? 'Completado' : 'Pendiente',
                                hasITLT ? 'Completado' : 'Pendiente',
                                completionScore === 6 ? 'Completo' : `Parcial (${completionScore}/6)`,
                                `${completionScore}/6`,
                                calificacionIA,
                                new Date().toLocaleString()
                            ];
                        })()
                    }
                };

                // Intentar enviar via Google Apps Script
                try {
                    // URL del Google Apps Script Web App
                    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbztF9IbRrJN1Ba0ldmZzCwqFyb-Qp_nH1So_F7LWJrkcqeo4T5KeM-7ypd8twEl6WM/exec';
                    
                    // Intentar POST primero, si falla usar GET
                    let response;
                    try {
                        response = await fetch(GAS_WEB_APP_URL, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                action: 'addData',
                                sheetId: GOOGLE_SHEETS_CONFIG.SHEET_ID,
                                sheetsData: sheetsData
                            }),
                            mode: 'no-cors' // Cambiar a no-cors para evitar preflight
                        });
                        
                        // Con no-cors no podemos leer la respuesta, asumir √©xito
                        console.log('‚úÖ Datos enviados via POST (no-cors)');
                        return true;
                        
                    } catch (postError) {
                        console.log('POST fall√≥, usando modo simulado...', postError.message);
                    }
                    
                } catch (fetchError) {
                    console.warn('‚ö†Ô∏è Google Apps Script no disponible, usando modo simulado:', fetchError.message);
                }
                
                // Modo simulado: mostrar datos en consola
                console.log('üìä DATOS QUE SE ENVIAR√çAN A GOOGLE SHEETS:');
                console.log('Sheet ID:', GOOGLE_SHEETS_CONFIG.SHEET_ID);
                console.log('Datos preparados:', sheetsData);
                
                // Crear un resumen visual para el usuario
                const summaryData = [
                    `ID: ${data.ID_Accidente}`,
                    `Trabajador: ${data.Nombre} (${data.Ficha})`,
                    `Fecha: ${data.Fecha_Incidente}`,
                    `ITL-1: ${data.Relato_Hechos ? '‚úÖ' : '‚ùå'}`,
                    `ITL-2: ${data.Relato_Medico || data.Medico ? '‚úÖ' : '‚ùå'}`,
                    `ITL-3: ${data.Condiciones_Inseguras || data.Actos_Inseguros ? '‚úÖ' : '‚ùå'}`
                ];
                
                console.log('üìã RESUMEN:', summaryData.join(' | '));
                
                // Simular √©xito parcial
                return true;
                
            } catch (error) {
                console.error('‚ùå Error enviando a Google Sheets:', error);
                showStatus(`‚ö†Ô∏è Error enviando a Google Sheets: ${error.message}`, 'error');
                return false;
            }
        }

        // Funci√≥n de fallback con patrones m√°s simples
        function extractWithSimplePatterns(text) {
            console.log('üîç Usando patrones de fallback...');
            const data = {};
            
            // Buscar patrones muy b√°sicos
            const simplePatterns = [
                { key: 'Ficha', pattern: /349201/ },
                { key: 'Nombre', pattern: /Enriqueta.*?Pacheco/i },
                { key: 'Centro_Trabajo', pattern: /Oficinas Centrales/i },
                { key: 'Departamento', pattern: /Gerencia.*?Comercializaci√≥n/i },
                { key: 'Categoria', pattern: /Subgerente/i },
                { key: 'Fecha_Incidente', pattern: /25.*?2.*?2025/i },
                { key: 'Medico', pattern: /JORGE.*?TAMAYO/i },
                { key: 'Diagnostico', pattern: /W01\.0/i },
                { key: 'Condiciones_Inseguras', pattern: /Agente defectuoso/i },
                { key: 'Actos_Inseguros', pattern: /Ninguno/i }
            ];
            
            simplePatterns.forEach(({key, pattern}) => {
                const match = text.match(pattern);
                if (match) {
                    data[key] = match[0];
                    console.log(`‚úÖ ${key} encontrado (simple):`, match[0]);
                }
            });
            
            return data;
        }

        function extractDataWithAdvancedPatterns(text) {
            console.log('Texto extra√≠do del PDF:', text.substring(0, 1000) + '...');
            
            const data = {};
            
            // Patrones de regex mejorados basados en los documentos reales
            const patterns = {
                // Datos b√°sicos del trabajador - Patrones m√°s espec√≠ficos
                Ficha: [
                    /Ficha:\s*(\d{6})/i,
                    /Ficha\s+(\d{6})/i,
                    /trabajador.*?Ficha:\s*(\d{6})/i,
                    /349201/i  // Patr√≥n espec√≠fico encontrado en el documento
                ],
                
                Nombre: [
                    /Nombre del trabajador.*?:\s*([A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±\s]{8,50})/i,
                    /trabajador.*?:\s*([A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±\s]{8,50})/i,
                    /Enriqueta del R[i√≠]o Pacheco/i  // Nombre espec√≠fico del documento
                ],
                
                // Fecha y hora del incidente - Patrones m√°s flexibles
                Fecha_Incidente: [
                    /Fecha y hora en que se lesion[√≥o].*?(\d{1,2}\s*\/\s*\d{1,2}\s*\/\s*\d{4}.*?a las\s*\d{1,2}:\d{2})/i,
                    /se lesion[√≥o].*?(\d{1,2}\s*\/\s*\d{1,2}\s*\/\s*\d{4})/i,
                    /(\d{1,2}\s*\/\s*\d{1,2}\s*\/\s*\d{4}\s*a las\s*\d{1,2}:\d{2})/i,
                    /25.*?2.*?2025.*?a las.*?16.*?15/i  // Patr√≥n espec√≠fico del documento
                ],
                
                // Centro de trabajo
                Centro_Trabajo: [
                    /Centro de Trabajo:\s*([^\n\r]{10,80})/i,
                    /Oficinas Centrales[,\s]*Centro Administrativo Pemex/i
                ],
                
                // Departamento
                Departamento: [
                    /Departamento de adscripci[√≥o]n:\s*([^\n\r]{10,100})/i,
                    /adscripci[√≥o]n:\s*([^\n\r]{10,100})/i,
                    /Gerencia de Comercializaci[√≥o]n de Gas LP y Residuales/i
                ],
                
                Categoria: [
                    /Categor[√≠i]a:\s*([A-Za-z\s]{4,20})/i,
                    /Subgerente/i
                ],
                
                // Relatos - Patrones m√°s amplios para capturar texto largo
                Relato_Hechos: [
                    /Relato de la forma en que ocurri[√≥o] la lesi[√≥o]n:([\s\S]*?)(?:Se anexa|Nombre|Original|$)/i,
                    /forma en que ocurri[√≥o]([\s\S]*?)(?:Se anexa|Nombre|Original|$)/i,
                    /El 25 de febrero del presente([\s\S]*?)(?:De las condiciones|$)/i
                ],
                
                Relato_Medico: [
                    /Descripci[√≥o]n detallada del mecanismo de la lesi[√≥o]n([\s\S]*?)(?:Parte.*del cuerpo|Las lesiones|$)/i,
                    /PACIENTE FEMENINA([\s\S]*?)(?:Parte.*del cuerpo|Las lesiones|$)/i,
                    /mecanismo de la lesi[√≥o]n[^\n\r]*?([\s\S]*?)(?:Parte|Las lesiones|$)/i
                ],
                
                // Condiciones de seguridad - Patrones espec√≠ficos
                Condiciones_Inseguras: [
                    /Condici[√≥o]n insegura:\s*([A-Za-z\s]{3,50})/i,
                    /Causa directa o factor preponderante:\s*([A-Za-z\s]{3,50})/i,
                    /Agente defectuoso/i
                ],
                
                Actos_Inseguros: [
                    /Acto inseguro:\s*([A-Za-z\s]{3,50})/i,
                    /Ninguno/i
                ],
                
                // Informaci√≥n m√©dica
                Medico: [
                    /Nombre del m[√©e]dico[:\s]*([A-Z√Å√â√ç√ì√ö√ë][A-Za-z\s\.]{10,50})/i,
                    /DR\.\s*([A-Z√Å√â√ç√ì√ö√ë][A-Za-z\s]{10,50})/i,
                    /JORGE JULIO TAMAYO CASTELAR/i
                ],
                
                Diagnostico: [
                    /(W\d{2}\.\d+:?[^\n\r]{5,100})/i,
                    /W01\.0.*?Ca√≠da al mismo nivel/i,
                    /Ca√≠da al mismo nivel por tropez[√≥o]n o resbal[√≥o]n/i
                ],
                
                Fecha_Atencion: [
                    /hora en que se otorg[√≥o] la atenci[√≥o]n m[√©e]dica:\s*([\d:]{4,8})/i,
                    /20:20\s*hrs/i
                ],
                
                Unidad_Medica: [
                    /Unidad M[√©e]dica que emite el documento:\s*([^\n\r]{10,80})/i,
                    /UNIDAD M[√âE]DICA DEL CENTRO ADMINISTRATIVO/i
                ],
                
                // ITL-4 PATRONES (NUEVOS)
                Calificacion_Accidente: [
                    /el accidente se califica como:?\s*([S√ç|NO]\s*DE\s*TRABAJO)/i,
                    /Como resultado del an[√°a]lisis efectuado[,\s]*el accidente se califica como\s*:\s*(S√ç\s*DE\s*TRABAJO|NO\s*DE\s*TRABAJO)/i,
                    /(S√ç\s*DE\s*TRABAJO|NO\s*DE\s*TRABAJO)/i
                ],
                
                Fundamento_Legal: [
                    /Con base en:\s*([^\n\r]{10,100})/i,
                    /(Cl[√°a]u?\.\s*\d+[^\n\r]{0,50})/i,
                    /(Art\.\s*\d+[^\n\r]{0,50})/i,
                    /Cl[√°a]u\.\s*115\s*y\s*123/i
                ],
                
                Formatos_Considerados: [
                    /Para la calificaci[√≥o]n se consider[√≥o]:\s*([^\n\r]{10,100})/i,
                    /(ITL-[1-3][^\n\r]{0,50})/i,
                    /ITL-1.*?ITL-2.*?ITL-3/i
                ],
                
                Observaciones: [
                    /OBSERVACIONES:\s*([^\n\r]{10,200})/i,
                    /Se califica como[^\n\r]{10,200}/i
                ],
                
                Fecha_Calificacion: [
                    /(\d{1,2}\s*de\s*\w+\s*de\s*\d{4})/i,
                    /Fecha[:\s]*(\d{1,2}\/\d{1,2}\/\d{4})/i
                ],
                
                Responsable_Calificacion: [
                    /Lic\.\s*([A-Z√Å√â√ç√ì√ö√ë][A-Za-z\s\.]{10,50})/i,
                    /S\.P\.A\.\s*del\s*Jefe\s*del\s*Departamento/i
                ],
                
                // ITL-5 PATRONES (NUEVOS)
                Costo_Total: [
                    /Origen[√≥o]\s*un\s*costo\s*total\s*por\s*atenci[√≥o]n\s*m[√©e]dica\s*de\s*\$?\s*([\d,\.]+)/i,
                    /costo\s*total[^\$]*\$\s*([\d,\.]+)/i,
                    /\$\s*([\d,\.]+)/i
                ],
                
                Tipo_Incapacidad: [
                    /Incapacidad:\s*(Temporal|Permanente\s*parcial|Permanente\s*total|Muerte)/i,
                    /(Temporal|Permanente\s*parcial|Permanente\s*total|Muerte)/i
                ],
                
                Dias_Incapacidad: [
                    /D[√≠i]as\s*de\s*incapacidad[^\d]*(\d{1,3})/i,
                    /incapacidad[^\d]*(\d{1,3})\s*d[√≠i]as/i
                ],
                
                Fecha_Alta: [
                    /Al:\s*(\d{1,2}\/\d{1,2}\/\d{4})/i,
                    /fecha\s*alta[:\s]*(\d{1,2}\/\d{1,2}\/\d{4})/i
                ],
                
                Responsable_Costos: [
                    /Por\s*el\s*Servicio\s*M[√©e]dico:\s*([A-Z√Å√â√ç√ì√ö√ë][^\n\r]{10,50})/i,
                    /ING\.\s*([A-Z√Å√â√ç√ì√ö√ë][A-Za-z\s\.]{10,50})/i
                ],
                
                // ITL-T PATRONES (NUEVOS)
                Lugar_Accidente: [
                    /lugar\s*donde\s*se\s*lesion[√≥o]:\s*([^\n\r]{10,100})/i,
                    /Lugar\s*del\s*accidente:\s*([^\n\r]{10,100})/i
                ],
                
                Domicilio_Trabajador: [
                    /Domicilio\s*del\s*trabajador:\s*([^\n\r]{10,150})/i,
                    /domicilio[:\s]*([^\n\r]{10,150})/i
                ],
                
                Documentos_Probatorios: [
                    /Documentos\s*con\s*los\s*que\s*se\s*comprueba\s*la\s*lesi[√≥o]n:\s*([^\n\r]{10,200})/i,
                    /documentos\s*probatorios[:\s]*([^\n\r]{10,200})/i
                ],
                
                Es_Traslado: [
                    /(traslado|trayecto)/i,
                    /ITL-T/i,
                    /TRASLADO/i
                ],
                
                // Patrones adicionales espec√≠ficos del documento
                Ubicacion_Accidente: [
                    /Departamento o [√°a]rea en donde se lesion[√≥o]:\s*([^\n\r]{10,100})/i,
                    /Pasillo de acceso de la puerta 15 al Edificio B2/i
                ],
                
                Telefono: [
                    /Ext.*?Tel[√©e]fono:\s*([\d\s]+)/i
                ],
                
                Clave_Centro: [
                    /Clave:\s*(\d{4})/i,
                    /2001/i
                ]
            };

            // Aplicar patrones y extraer datos
            for (const [key, patternArray] of Object.entries(patterns)) {
                for (const pattern of patternArray) {
                    const match = text.match(pattern);
                    if (match) {
                        // Si hay grupo de captura, usarlo; si no, usar todo el match
                        const value = match[1] ? match[1].trim() : match[0].trim();
                        if (value && value.length > 1) {
                            data[key] = value;
                            console.log(`‚úÖ ${key} encontrado:`, value);
                            break;
                        }
                    }
                }
                
                // Si no se encontr√≥ el campo, registrarlo
                if (!data[key]) {
                    console.log(`‚ùå ${key} no encontrado`);
                }
            }

            // Buscar patrones espec√≠ficos del documento actual
            const specificMatches = {
                Ficha: text.match(/349201/),
                Nombre: text.match(/Enriqueta del R[i√≠]o Pacheco/i),
                Centro_Trabajo: text.match(/Oficinas Centrales[,\s]*Centro Administrativo Pemex/i),
                Departamento: text.match(/Gerencia de Comercializaci[√≥o]n de Gas LP y Residuales/i),
                Categoria: text.match(/Subgerente/i),
                Fecha_Incidente: text.match(/25.*?2.*?2025.*?16.*?15/i),
                Medico: text.match(/JORGE JULIO TAMAYO CASTELAR/i),
                Diagnostico: text.match(/W01\.0.*?Ca√≠da/i),
                Condiciones_Inseguras: text.match(/Agente defectuoso/i),
                Actos_Inseguros: text.match(/Ninguno/i),
                Unidad_Medica: text.match(/UNIDAD M[√âE]DICA DEL CENTRO ADMINISTRATIVO/i)
            };

            // Agregar matches espec√≠ficos encontrados
            for (const [key, match] of Object.entries(specificMatches)) {
                if (match && !data[key]) {
                    data[key] = match[0];
                    console.log(`‚úÖ ${key} encontrado (espec√≠fico):`, match[0]);
                }
            }

            // Buscar el relato largo del ITL-3
            const relatoMatch = text.match(/El 25 de febrero del presente([\s\S]*?)De las condiciones del trabajo/i);
            if (relatoMatch && !data.Relato_Hechos) {
                data.Relato_Hechos = relatoMatch[1].trim();
                console.log(`‚úÖ Relato_Hechos encontrado (ITL-3):`, data.Relato_Hechos.substring(0, 100) + '...');
            }

            // Buscar el relato m√©dico
            const medicoMatch = text.match(/PACIENTE FEMENINA DE 57 A√ëOS([\s\S]*?)Parte.*del cuerpo/i);
            if (medicoMatch && !data.Relato_Medico) {
                data.Relato_Medico = 'PACIENTE FEMENINA DE 57 A√ëOS' + medicoMatch[1].trim();
                console.log(`‚úÖ Relato_Medico encontrado:`, data.Relato_Medico.substring(0, 100) + '...');
            }

            // Determinar tipo de accidente
            if (!data.Tipo_Accidente) {
                data.Tipo_Accidente = text.includes('ITL-1') || text.includes('INFORME DE TRABAJADOR') ? 'De Trabajo' : 'De Trayecto';
            }

            // Limpiar y validar datos
            Object.keys(data).forEach(key => {
                if (data[key] && typeof data[key] === 'string') {
                    data[key] = data[key]
                        .replace(/\s+/g, ' ')  // Normalizar espacios
                        .replace(/^\s*[:\-\s]+/, '')  // Remover prefijos como ": "
                        .trim();
                        
                    if (data[key].length > 300) {
                        data[key] = data[key].substring(0, 300) + '...';
                    }
                } else if (data[key] && typeof data[key] !== 'string') {
                    data[key] = String(data[key]).trim();
                }
                
                // Remover campos vac√≠os
                if (!data[key] || (typeof data[key] === 'string' && data[key].trim() === '')) {
                    delete data[key];
                }
            });

            console.log('üìä Datos finales extra√≠dos:', data);
            console.log('üìä Total de campos encontrados:', Object.keys(data).length);
            
            return data;
        }

        function displayResults(data) {
            console.log('üîç Datos recibidos para mostrar:', data);
            console.log('üîç Relato_Hechos:', data.Relato_Hechos);
            console.log('üîç Relato_Medico:', data.Relato_Medico);
            console.log('üîç Condiciones_Inseguras:', data.Condiciones_Inseguras);
            
            const extractedDataDiv = document.getElementById('extractedData');
            const processStatus = document.getElementById('processStatus');
            const resultSection = document.getElementById('resultSection');
            
            // Mostrar datos extra√≠dos
            extractedDataDiv.innerHTML = '';
            
            const fieldsToShow = [
                {key: 'ID_Accidente', label: 'ID del Accidente'},
                {key: 'Ficha', label: 'Ficha del Trabajador'},
                {key: 'Nombre', label: 'Nombre Completo'},
                {key: 'Fecha_Incidente', label: 'Fecha del Incidente'},
                {key: 'Centro_Trabajo', label: 'Centro de Trabajo'},
                {key: 'Departamento', label: 'Departamento'},
                {key: 'Categoria', label: 'Categor√≠a'},
                {key: 'Clave_Centro', label: 'Clave Centro'},
                {key: 'Relato_Hechos', label: 'Relato de los Hechos'},
                {key: 'Relato_Medico', label: 'Relato M√©dico'},
                {key: 'Condiciones_Inseguras', label: 'Condiciones Inseguras'},
                {key: 'Actos_Inseguros', label: 'Actos Inseguros'},
                {key: 'Medico', label: 'M√©dico Tratante'},
                {key: 'Diagnostico', label: 'Diagn√≥stico'},
                {key: 'Unidad_Medica', label: 'Unidad M√©dica'},
                {key: 'Fecha_Atencion', label: 'Fecha de Atenci√≥n'},
                // ITL-4 campos
                {key: 'Calificacion_Accidente', label: 'Calificaci√≥n del Accidente'},
                {key: 'Fundamento_Legal', label: 'Fundamento Legal'},
                {key: 'Formatos_Considerados', label: 'Formatos Considerados'},
                {key: 'Observaciones', label: 'Observaciones'},
                {key: 'Fecha_Calificacion', label: 'Fecha de Calificaci√≥n'},
                {key: 'Responsable_Calificacion', label: 'Responsable Calificaci√≥n'},
                // ITL-5 campos
                {key: 'Costo_Total', label: 'Costo Total Atenci√≥n'},
                {key: 'Tipo_Incapacidad', label: 'Tipo de Incapacidad'},
                {key: 'Dias_Incapacidad', label: 'D√≠as de Incapacidad'},
                {key: 'Fecha_Alta', label: 'Fecha de Alta'},
                {key: 'Responsable_Costos', label: 'Responsable Costos'},
                // ITL-T campos
                {key: 'Lugar_Accidente', label: 'Lugar del Accidente'},
                {key: 'Domicilio_Trabajador', label: 'Domicilio del Trabajador'},
                {key: 'Documentos_Probatorios', label: 'Documentos Probatorios'},
                {key: 'Es_Traslado', label: 'Es Accidente de Traslado'}
            ];

            fieldsToShow.forEach(field => {
                const value = data[field.key];
                // Verificar que value existe y es string antes de usar trim
                if (value && typeof value === 'string' && value.trim() !== '') {
                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'field-display p-4 rounded-lg';
                    fieldDiv.innerHTML = `
                        <div class="text-blue-200 text-sm font-medium">${field.label}</div>
                        <div class="text-white text-base mt-1 break-words">${value}</div>
                    `;
                    extractedDataDiv.appendChild(fieldDiv);
                } else if (value && typeof value !== 'string') {
                    // Si el valor existe pero no es string, convertirlo
                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'field-display p-4 rounded-lg';
                    fieldDiv.innerHTML = `
                        <div class="text-blue-200 text-sm font-medium">${field.label}</div>
                        <div class="text-white text-base mt-1 break-words">${String(value)}</div>
                    `;
                    extractedDataDiv.appendChild(fieldDiv);
                }
            });

            // Determinar estado de cada ITL
            const hasITL1 = data.Relato_Hechos && data.Relato_Hechos !== 'Se anexa relato' && data.Relato_Hechos.length > 20;
            const hasITL2 = (data.Relato_Medico && data.Relato_Medico.length > 10) || (data.Medico && data.Diagnostico);
            const hasITL3 = data.Condiciones_Inseguras || data.Actos_Inseguros;
            const hasITL4 = data.Calificacion_Accidente && data.Fundamento_Legal;
            const hasITL5 = data.Costo_Total || data.Tipo_Incapacidad;
            const hasITLT = data.Lugar_Accidente && data.Relato_Hechos;

            // Mostrar estado del proceso
            const statusItems = [
                { 
                    text: 'ITL-1 (Informe del Trabajador)', 
                    status: hasITL1 ? '‚úÖ Completado' : '‚ùå No encontrado',
                    found: hasITL1
                },
                { 
                    text: 'ITL-2 (Condici√≥n del Trabajador)', 
                    status: hasITL2 ? '‚úÖ Completado' : '‚ùå No encontrado',
                    found: hasITL2
                },
                { 
                    text: 'ITL-3 (Reporte de Seguridad)', 
                    status: hasITL3 ? '‚úÖ Completado' : '‚ùå No encontrado',
                    found: hasITL3
                },
                { 
                    text: 'ITL-4 (Calificaci√≥n del Accidente)', 
                    status: hasITL4 ? '‚úÖ Completado' : '‚ùå No encontrado',
                    found: hasITL4
                },
                { 
                    text: 'ITL-5 (Costos de Atenci√≥n M√©dica)', 
                    status: hasITL5 ? '‚úÖ Completado' : '‚ùå No encontrado',
                    found: hasITL5
                },
                { 
                    text: 'ITL-T (Accidente de Traslado)', 
                    status: hasITLT ? '‚úÖ Completado' : '‚ùå No encontrado',
                    found: hasITLT
                },
                { 
                    text: 'Datos B√°sicos', 
                    status: (data.Ficha && data.Nombre) ? '‚úÖ Completado' : '‚ùå Incompleto',
                    found: !!(data.Ficha && data.Nombre)
                }
            ];

            processStatus.innerHTML = statusItems.map(item => `
                <div class="flex justify-between items-center bg-white bg-opacity-10 p-3 rounded-lg">
                    <span class="text-white font-medium">${item.text}</span>
                    <span class="${item.found ? 'text-green-400' : 'text-red-400'} font-semibold">${item.status}</span>
                </div>
            `).join('');

            // Agregar cuadro de interpretaci√≥n IA
            const iaInterpretation = generateCalificacionIA(data);
            const iaSection = document.createElement('div');
            iaSection.className = 'bg-blue-600 bg-opacity-20 border border-blue-400 rounded-xl p-6 mt-6';
            iaSection.innerHTML = `
                <h3 class="text-xl font-semibold text-blue-200 mb-4 flex items-center">
                    <span class="bg-blue-500 rounded-full p-2 mr-3">ü§ñ</span>
                    Estatus de Calificaci√≥n IA (DTO-PACH-RL-03)
                </h3>
                <div class="text-white text-base leading-relaxed bg-blue-900 bg-opacity-30 p-4 rounded-lg">
                    ${iaInterpretation}
                </div>
                <div class="text-blue-300 text-xs mt-3">
                    ‚öñÔ∏è Interpretaci√≥n basada en normativa PEMEX DTO-PACH-RL-03 | Art. 474 LFT | Cl√°usulas CCT
                </div>
            `;
            
            document.getElementById('resultSection').appendChild(iaSection);

            resultSection.classList.remove('hidden');
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            
            let className = 'mt-6 p-4 rounded-lg ';
            if (type === 'success') {
                className += 'bg-green-500 bg-opacity-20 text-green-300 border border-green-500 success-animation';
            } else if (type === 'error') {
                className += 'bg-red-500 bg-opacity-20 text-red-300 border border-red-500';
            } else if (type === 'info') {
                className += 'bg-blue-500 bg-opacity-20 text-blue-300 border border-blue-500';
            }
            
            status.className = className;
            status.classList.remove('hidden');
        }

        // Funci√≥n para mostrar ayuda
        function showHelp() {
            const helpContent = `
            <div class="bg-blue-900 bg-opacity-30 p-6 rounded-xl">
                <h3 class="text-xl font-bold text-white mb-4">üìö Ayuda del Sistema ITL</h3>
                
                <div class="space-y-4 text-white">
                    <div>
                        <h4 class="font-semibold text-blue-200">üîç Procesamiento Autom√°tico:</h4>
                        <p class="text-sm">El sistema lee autom√°ticamente formularios ITL escaneados, incluyendo texto manuscrito.</p>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-blue-200">üìä Google Sheets:</h4>
                        <p class="text-sm">Env√≠a autom√°ticamente los datos a Google Sheets con 8 hojas organizadas.</p>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-blue-200">ü§ñ Interpretaci√≥n IA:</h4>
                        <p class="text-sm">Genera interpretaciones autom√°ticas seg√∫n normativa DTO-PACH-RL-03.</p>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-blue-200">üîí Seguridad:</h4>
                        <p class="text-sm">Todos los datos se procesan localmente. Solo se env√≠a a Google Sheets autorizado.</p>
                    </div>
                </div>
                
                <button onclick="this.parentElement.parentElement.style.display='none'" 
                        class="mt-4 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-white">
                    Cerrar Ayuda
                </button>
            </div>
            `;
            
            const helpDiv = document.createElement('div');
            helpDiv.innerHTML = helpContent;
            helpDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            helpDiv.onclick = function(e) {
                if (e.target === helpDiv) {
                    document.body.removeChild(helpDiv);
                }
            };
            
            document.body.appendChild(helpDiv);
        }

        // Agregar bot√≥n de ayuda
        document.addEventListener('DOMContentLoaded', function() {
            const helpButton = document.createElement('button');
            helpButton.className = 'fixed bottom-4 right-4 bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-full shadow-lg z-40';
            helpButton.innerHTML = '‚ùì';
            helpButton.onclick = showHelp;
            helpButton.title = 'Ayuda del Sistema';
            document.body.appendChild(helpButton);
        });

        // Informaci√≥n del sistema al cargar
        console.log(`
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë               SISTEMA ITL PEMEX v4.0                         ‚ïë
‚ïë     Procesador Completo DTO-PACH-RL-03 - Sin Servidor       ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë ‚úÖ Soporte completo para ITL-1, ITL-2, ITL-3               ‚ïë
‚ïë ‚úÖ NUEVO: Soporte para ITL-4 (Calificaci√≥n)                ‚ïë
‚ïë ‚úÖ NUEVO: Soporte para ITL-5 (Costos M√©dicos)              ‚ïë
‚ïë ‚úÖ NUEVO: Soporte para ITL-T (Traslado)                    ‚ïë
‚ïë ‚úÖ Generaci√≥n de 8 hojas de Excel completas                ‚ïë
‚ïë ‚úÖ Extracci√≥n inteligente con Azure GPT-4o                 ‚ïë
‚ïë ‚úÖ Env√≠o autom√°tico a Google Sheets                        ‚ïë
‚ïë ‚úÖ Validaci√≥n autom√°tica de completitud 6/6                ‚ïë
‚ïë ‚úÖ Cumple completamente con DTO-PACH-RL-03                 ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

üöÄ FORMULARIOS SOPORTADOS (VARIABLE):
- ITL-1: Informe de Trabajador Lesionado
- ITL-2: Condici√≥n de Trabajador Lesionado  
- ITL-3: Reporte de Seguridad
- ITL-4: Calificaci√≥n del Accidente (NUEVO)
- ITL-5: Costos de la Atenci√≥n M√©dica (NUEVO)
- ITL-T: Informe de Trabajador Lesionado en Traslado (NUEVO)

üìä HOJAS DE EXCEL GENERADAS (8 HOJAS):
1. Accidentes_Trabajo (con calificaci√≥n, costos, tipo incapacidad)
2. ITL_1_Informe_Trabajador
3. ITL_2_Condicion_Trabajador  
4. ITL_3_Reporte_Seguridad
5. ITL_4_Calificacion_Accidente (NUEVA)
6. ITL_5_Costos_Atencion (NUEVA)
7. ITL_T_Traslado (NUEVA)
8. Resumen (actualizado con 6 formularios)

üîß CARACTER√çSTICAS AVANZADAS:
- Procesamiento variable (algunos PDFs tendr√°n 3 ITL, otros 6)
- Detecci√≥n autom√°tica de tipo de formulario
- Sin duplicados en env√≠os a Google Sheets
- Validaci√≥n completa de completitud (X/6)
- Cumplimiento total con normativa PEMEX DTO-PACH-RL-03
        `);
    </script>
</body>
</html>

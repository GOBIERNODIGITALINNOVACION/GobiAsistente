<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema ITL PEMEX - An√°lisis Individual</title>
    <link href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 50%, #581c87 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .success-message {
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .field-display {
            background: rgba(59, 130, 246, 0.1);
            border-left: 4px solid #3b82f6;
        }
        .pdf-button {
            background: linear-gradient(to right, #1e40af, #3730a3);
            transition: all 0.3s ease;
        }
        .pdf-button:hover {
            background: linear-gradient(to right, #1e3a8a, #312e81);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(30, 64, 175, 0.3);
        }
        .clear-button {
            background: linear-gradient(to right, #dc2626, #991b1b);
            transition: all 0.3s ease;
        }
        .clear-button:hover {
            background: linear-gradient(to right, #b91c1c, #7f1d1d);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(220, 38, 38, 0.3);
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .accordion-content.open {
            max-height: 1000px;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="text-center mb-8">
            <div class="flex justify-center items-center mb-4">
                <div class="bg-white rounded-full p-3 mr-4">
                    <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 2a1 1 0 00 0 2h2a1 1 0 00 0-2H9z"/>
                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2h.01c0 1.1.9 2 2 2v6a2 2 0 01-2 2H6a4 4 0 01-4-4V5zm10-2a2 2 0 012 2v6a2 2 0 01-2 2h-.01a2 2 0 01-2-2V5a2 2 0 012-2z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <h1 class="text-4xl font-bold text-white">Sistema ITL - PEMEX</h1>
            </div>
            <p class="text-white opacity-90 text-lg">An√°lisis Individual de Accidentes de Trabajo</p>
            <p class="text-blue-200 text-sm mt-2">‚ú® UN CASO POR PDF - Conforme a DTO-PACH-RL-03 ‚ú®</p>
        </div>

        <div class="glass-effect rounded-3xl p-8 shadow-2xl mb-8">
            <div class="mb-8">
                <h2 class="text-3xl font-semibold text-white mb-6 flex items-center">
                    <span class="bg-blue-500 rounded-full p-2 mr-3">üìÅ</span>
                    Cargar y Analizar Formulario ITL Individual
                </h2>
                <div class="bg-white bg-opacity-10 rounded-xl p-6">
                    <div class="mb-6 p-4 bg-blue-500 bg-opacity-20 border border-blue-500 rounded-lg">
                        <h4 class="text-blue-200 font-semibold mb-2">‚úÖ Azure GPT-4o Configurado</h4>
                        <p class="text-blue-200 text-sm">Sistema listo para analizar PDF individual y generar dictamen</p>
                        <p class="text-blue-300 text-xs mt-1">Nota: Cada PDF debe contener informaci√≥n de UNA SOLA PERSONA</p>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-white text-sm font-medium mb-2">Seleccionar archivo PDF (un caso por archivo):</label>
                        <input type="file" id="pdfFile" accept=".pdf" 
                               class="block w-full text-white bg-white bg-opacity-20 rounded-lg p-4 mb-4
                                      file:mr-4 file:py-3 file:px-6 file:rounded-lg file:border-0
                                      file:text-sm file:font-semibold file:bg-blue-600 file:text-white
                                      hover:file:bg-blue-700 transition-all duration-200">
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button id="extractButton" 
                                class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 
                                       text-white px-8 py-4 rounded-xl font-semibold text-lg transition-all duration-300 
                                       transform hover:scale-105 shadow-lg">
                            üîç Analizar Caso Individual
                        </button>
                        
                        <button id="downloadPDFButton" 
                                class="w-full pdf-button text-white px-8 py-4 rounded-xl font-semibold text-lg disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>
                            üìÑ Generar Dictamen PDF
                        </button>
                        
                        <button id="clearButton" 
                                class="w-full clear-button text-white px-8 py-4 rounded-xl font-semibold text-lg">
                            üóëÔ∏è Limpiar y Subir Otro
                        </button>
                    </div>
                    
                    <div id="loadingSection" class="hidden mt-6 text-center">
                        <div class="loading-spinner mx-auto mb-4"></div>
                        <p class="text-white text-lg" id="loadingText">Procesando caso individual...</p>
                        <p class="text-blue-200 text-sm">Esto puede tomar unos segundos</p>
                    </div>

                    <div id="status" class="mt-6 p-4 rounded-lg hidden"></div>
                </div>
            </div>
        </div>

        <div id="resultSection" class="glass-effect rounded-3xl p-8 shadow-2xl hidden">
            <h2 class="text-3xl font-semibold text-white mb-6 flex items-center">
                <span class="bg-green-500 rounded-full p-2 mr-3">‚úÖ</span>
                Resultado del An√°lisis Individual
            </h2>
            <div id="extractedData" class="mb-8"></div>
            
            <div class="bg-white bg-opacity-10 rounded-xl p-6">
                <h3 class="text-xl font-semibold text-white mb-4">üìä Estado de los Formularios ITL:</h3>
                <div id="processStatus"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n y variables globales
        let caseData = null;
        let analysisResult = null;
        let currentAccidentId = 1;

        // Configuraci√≥n de Azure OpenAI (GPT-4o)
        const AZURE_CONFIG = {
            endpoint: "https://cuente8n8.openai.azure.com/",
            apiKey: "4C0mfORSac5WlA2LXBWDXkxI6WF8f0HENRpytmkObBRMlnjLkTjaJQQJ99BEACYeBjFXJ3w3AAABACOGixsB",
            deployment: "gpt-4oromanpemex",
            apiVersion: "2024-12-01-preview"
        };

        // Configuraci√≥n de PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Prompt de an√°lisis actualizado para casos individuales
        const ANALYSIS_PROMPT = `
**Contexto**: Eres un analista experto en relaciones laborales y seguridad ocupacional en Petr√≥leos Mexicanos (Pemex), con m√°s de 10 a√±os de experiencia en an√°lisis de accidentes laborales y cumplimiento normativo. Tu tarea es revisar UNA SOLA solicitud de accidente de trabajo (formatos ITL-1, ITL-2, ITL-3, ITL-4, ITL-5, ITL-T) conforme al documento DTO-PACH-RL-03, la Ley Federal del Trabajo (LFT), el Contrato Colectivo de Trabajo (CCT), el Reglamento de Seguridad e Higiene de Pemex (RSHPMEPS), y el Sistema de Avisos de Accidentes de Trabajo (SIAAT). Debes emitir un dictamen sustentado, profesional y detallado sobre si el incidente es un "accidente de trabajo" o "no de trabajo", y recomendar acciones espec√≠ficas con plazos.

**IMPORTANTE**: Este an√°lisis es para UN SOLO CASO/TRABAJADOR por PDF. No busques m√∫ltiples casos.

**Instrucciones**:
1. **Revisi√≥n del Caso Individual**:
   - Analiza los formatos ITL del trabajador espec√≠fico
   - Verifica campos completos, firmas y plazos (punto II.1.2 DTO-PACH-RL-03)
   - Confirma entrega del ITL-1 en 8 horas (punto II.1.9), ITL-3 en 24 horas (punto II.1.15)
   - Identifica inconsistencias en el relato (punto II.1.19)

2. **Evaluaci√≥n seg√∫n Normatividad**:
   - Verifica si cumple con el art√≠culo 474 LFT (accidente en centro de trabajo, actividades laborales, traslado)
   - Revisa excluyentes del art√≠culo 488 LFT (embriaguez, autolesi√≥n, imprudencia grave)
   - Eval√∫a la actividad (rutinaria/asignada) y su relaci√≥n con la categor√≠a del trabajador
   - Aplica cl√°usulas 114, 115, 123 CCT para sindicalizados, o art√≠culo 66 RTPC para confianza

3. **Criterios de Calificaci√≥n**:
   - **Accidente de trabajo**: Incidente en centro de trabajo o traslado, sin excluyentes del art√≠culo 488
   - **No accidente de trabajo**: Aplica excluyente del art√≠culo 488
   - **Suspensi√≥n**: Inconsistencias o datos insuficientes (punto II.1.3)

4. **Formato de Respuesta** (todos los campos deben ser strings):
{
  "Resumen": "Descripci√≥n del incidente (fecha, lugar, lesi√≥n, actividad del trabajador)",
  "Analisis": {
    "ITL-1": "An√°lisis del ITL-1: cumplimiento, relato, plazos",
    "ITL-2": "An√°lisis del ITL-2: diagn√≥stico m√©dico, consistencia",
    "ITL-3": "An√°lisis del ITL-3: causas, condiciones/actos inseguros",
    "ITL-4": "An√°lisis del ITL-4: calificaci√≥n, notificaci√≥n SIAAT",
    "ITL-5": "An√°lisis del ITL-5: costos, incapacidad",
    "ITL-T": "An√°lisis del ITL-T: traslado, pruebas"
  },
  "Dictamen": "Accidente de trabajo / No accidente / Suspensi√≥n",
  "Justificacion": "Justificaci√≥n normativa detallada con citas espec√≠ficas",
  "Incumplimientos": "Lista de incumplimientos detectados con evidencia",
  "Recomendaciones": "Acciones recomendadas con plazos espec√≠ficos"
}
`;

        // Event Listeners
        document.getElementById('extractButton').addEventListener('click', extractDataFromPDF);
        document.getElementById('downloadPDFButton').addEventListener('click', downloadPDF);
        document.getElementById('clearButton').addEventListener('click', clearForm);

        // Funci√≥n para limpiar el formulario
        function clearForm() {
            caseData = null;
            analysisResult = null;
            document.getElementById('pdfFile').value = '';
            document.getElementById('downloadPDFButton').disabled = true;
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('status').classList.add('hidden');
            showStatus('üóëÔ∏è Formulario limpiado. Sube un nuevo PDF.', 'success');
        }

        // Funci√≥n principal para extraer datos del PDF
        async function extractDataFromPDF() {
            const fileInput = document.getElementById('pdfFile');
            const loadingSection = document.getElementById('loadingSection');
            const status = document.getElementById('status');
            const resultSection = document.getElementById('resultSection');
            const loadingText = document.getElementById('loadingText');

            if (!fileInput.files.length) {
                showStatus('Por favor selecciona un archivo PDF', 'error');
                return;
            }

            try {
                loadingSection.classList.remove('hidden');
                status.classList.add('hidden');
                resultSection.classList.add('hidden');
                caseData = null;
                analysisResult = null;

                const file = fileInput.files[0];
                loadingText.textContent = 'Leyendo archivo PDF...';

                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                let fullText = '';
                const totalPages = pdf.numPages;

                // Extraer texto de todas las p√°ginas
                for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
                    loadingText.textContent = `Procesando p√°gina ${pageNum} de ${totalPages}...`;
                    const page = await pdf.getPage(pageNum);
                    const textContent = await page.getTextContent();
                    let pageText = '';
                    let lastY = null;

                    textContent.items.forEach((item, index) => {
                        if (lastY !== null && Math.abs(item.transform[5] - lastY) > 5) {
                            pageText += '\n';
                        }
                        pageText += item.str;
                        if (index < textContent.items.length - 1) {
                            const nextItem = textContent.items[index + 1];
                            const currentX = item.transform[4] + item.width;
                            const nextX = nextItem.transform[4];
                            if (nextX - currentX > 5) {
                                pageText += ' ';
                            }
                        }
                        lastY = item.transform[5];
                    });

                    fullText += pageText + '\n\n';
                }

                fullText = correctOCRText(fullText);

                if (!fullText.trim()) {
                    loadingText.textContent = 'PDF escaneado detectado - Procesando con Azure GPT-4o...';
                    caseData = await processWithAzureGPT4o(pdf, file.name);
                } else {
                    loadingText.textContent = 'Extrayendo datos del caso...';
                    caseData = extractSingleCaseData(fullText, file.name);
                }

                if (!caseData || Object.keys(caseData).length === 0) {
                    throw new Error('No se detect√≥ informaci√≥n v√°lida en el PDF');
                }

                currentAccidentId = Math.floor(Math.random() * 9000) + 1000;

                loadingText.textContent = 'Analizando caso con normatividad...';
                await analyzeWithPrompt(fullText, caseData);

                if (!analysisResult) {
                    throw new Error('No se gener√≥ an√°lisis v√°lido');
                }

                displayResult();
                showStatus('‚úÖ An√°lisis completado exitosamente para el caso individual.', 'success');
                document.getElementById('downloadPDFButton').disabled = false;

            } catch (error) {
                console.error('Error:', error);
                showStatus(`‚ùå Error al procesar: ${error.message}`, 'error');
            } finally {
                loadingSection.classList.add('hidden');
            }
        }

        // Funci√≥n para extraer datos de un solo caso
        function extractSingleCaseData(text, filename) {
            const data = {};
            
            // Patrones para extraer informaci√≥n del caso individual
            const patterns = {
                Ficha: [/Ficha:\s*(\d{6})/i, /Ficha\s+(\d{6})/i],
                Nombre: [
                    /Nombre del trabajador.*?:\s*([A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±\s]{8,50})/i,
                    /OFELIA\s+GARCIA\s+CANSECO/i,
                    /Ofelia\s+Garc√≠a\s+Canseco/i
                ],
                Fecha_Incidente: [
                    /Fecha y hora en que se lesion[√≥o].*?(\d{1,2}\s*\/\s*\d{1,2}\s*\/\s*\d{4}.*?a las\s*\d{1,2}:\d{2})/i,
                    /(\d{1,2}\s*\/\s*\d{1,2}\s*\/\s*\d{4}\s*a las\s*\d{1,2}:\d{2})/i
                ],
                Centro_Trabajo: [
                    /Centro de Trabajo:\s*([^\n\r]{10,80})/i, 
                    /PETR[√ìO]LEOS MEXICANOS/i,
                    /Oficinas Centrales/i
                ],
                Departamento: [
                    /Departamento de adscripci[√≥o]n:\s*([^\n\r]{10,100})/i, 
                    /SUBGERENCIA DE CALIDAD/i,
                    /SUBGERENCIA DE PLANEACI[√ìO]N/i
                ],
                Categoria: [
                    /Categor[√≠i]a:\s*([A-Za-z\s]{4,30})/i, 
                    /AUXILIAR ADMINISTRATIVO/i
                ],
                Clave_Centro: [/Clave:\s*(\d{4})/i],
                Relato_Hechos: [
                    /Relato de la forma en que ocurri[√≥o] la lesi[√≥o]n:([\s\S]*?)(?:Se anexa|Nombre|Original|$)/i,
                    /Al ir circulando([\s\S]*?)(?:Posteriormente|$)/i
                ],
                Relato_Medico: [
                    /Descripci[√≥o]n detallada del mecanismo de la lesi[√≥o]n([\s\S]*?)(?:Parte.*del cuerpo|Las lesiones|$)/i,
                    /REFIERE QUE([\s\S]*?)(?:Parte|$)/i
                ],
                Medico: [/Nombre del m[√©e]dico[:\s]*([A-Z√Å√â√ç√ì√ö√ë][A-Za-z\s\.]{10,50})/i],
                Diagnostico: [/(W\d{2}\.\d+:?[^\n\r]{5,100})/i, /esguince|contusi[√≥o]n/i],
                Condiciones_Inseguras: [/Condici[√≥o]n insegura:\s*([A-Za-z\s]{3,50})/i],
                Actos_Inseguros: [/Acto inseguro:\s*([A-Za-z\s]{3,50})/i],
                Calificacion_Accidente: [/(S[√çI]\s*DE\s*TRABAJO|NO\s*DE\s*TRABAJO)/i],
                Fundamento_Legal: [/Con base en:\s*([^\n\r]{10,100})/i, /(Cl[√°a]u?\.\s*\d+[^\n\r]{0,50})/i],
                Costo_Total: [/costo\s*total[^\$]*\$\s*([\d,\.]+)/i],
                Tipo_Incapacidad: [/(Temporal|Permanente\s*parcial|Permanente\s*total|Muerte)/i],
                Dias_Incapacidad: [/D[√≠i]as\s*de\s*incapacidad[^\d]*(\d{1,3})/i]
            };

            // Extraer nombre principal del archivo como fallback
            let primaryName = null;
            if (filename.toLowerCase().includes('ofelia')) {
                primaryName = 'Ofelia Garc√≠a Canseco';
            }

            // Buscar patrones en el texto
            for (const [key, patternArray] of Object.entries(patterns)) {
                for (const pattern of patternArray) {
                    const match = text.match(pattern);
                    if (match) {
                        const value = match[1] ? match[1].trim() : match[0].trim();
                        if (value && value.length > 1) {
                            data[key] = value;
                            break;
                        }
                    }
                }
            }

            // Asegurar que tenemos al menos nombre y ficha
            if (!data.Nombre && primaryName) {
                data.Nombre = primaryName;
            }
            if (!data.Ficha) {
                data.Ficha = extractFichaFromText(text) || 'Desconocida';
            }

            return data;
        }

        // Funci√≥n para extraer ficha del texto
        function extractFichaFromText(text) {
            const fichaMatch = text.match(/\b\d{6}\b/);
            return fichaMatch ? fichaMatch[0] : null;
        }

        // Funci√≥n para procesar PDF escaneado con Azure GPT-4o
        async function processWithAzureGPT4o(pdf, filename) {
            let extractedData = {};
            let hasMeaningfulData = false;

            // Procesar todas las p√°ginas y consolidar en un solo caso
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                try {
                    const page = await pdf.getPage(pageNum);
                    const viewport = page.getViewport({ scale: 3.0 });
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    await page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise;

                    const imageData = canvas.toDataURL('image/png').split(',')[1];
                    const pageData = await callAzureOpenAI(imageData, pageNum, 'extract');
                    
                    // Consolidar datos de todas las p√°ginas en un solo objeto
                    Object.assign(extractedData, pageData);
                    
                    if (Object.keys(pageData).length > 1) {
                        hasMeaningfulData = true;
                    }
                } catch (error) {
                    console.error(`Error procesando p√°gina ${pageNum}:`, error);
                }
            }

            // Si no hay datos significativos, crear caso b√°sico
            if (!hasMeaningfulData || Object.keys(extractedData).length === 0) {
                const name = extractNameFromFilename(filename) || 'Caso Desconocido';
                extractedData = { 
                    Nombre: name, 
                    Ficha: 'Desconocida',
                    Observaciones: 'Datos extra√≠dos de PDF escaneado con calidad limitada'
                };
            }

            return extractedData;
        }

        // Extraer nombre del archivo como fallback
        function extractNameFromFilename(filename) {
            const patterns = [
                /Ofelia\s+Garc[√≠i]a\s+Canseco/i,
                /Enriqueta\s+del\s+R[i√≠]o\s+Pacheco/i,
                /Roberto\s+Daniel\s+Manzo\s+Granados/i,
                /Jos[√©e]\s+Antonio\s+Guti[√©e]rrez\s+Cordero/i
            ];
            
            for (const pattern of patterns) {
                const match = filename.match(pattern);
                if (match) {
                    return match[0];
                }
            }
            return null;
        }

        // Funci√≥n para analizar con el prompt
        async function analyzeWithPrompt(fullText, caseData) {
            try {
                const prompt = `${ANALYSIS_PROMPT}\n\n**Datos del Caso Individual**:\n${JSON.stringify(caseData, null, 2)}\n\n**Texto Completo del PDF**:\n${fullText.substring(0, 8000)}`;
                const response = await callAzureOpenAI(null, 0, 'analyze', prompt);
                
                if (!response.Resumen || !response.Dictamen) {
                    throw new Error('An√°lisis incompleto');
                }
                
                // Normalizar respuesta asegurando que todos los campos sean strings
                analysisResult = {
                    Resumen: String(response.Resumen || 'No disponible'),
                    Analisis: response.Analisis || {
                        "ITL-1": "No disponible",
                        "ITL-2": "No disponible", 
                        "ITL-3": "No disponible",
                        "ITL-4": "No disponible",
                        "ITL-5": "No disponible",
                        "ITL-T": "No disponible"
                    },
                    Dictamen: String(response.Dictamen || 'No disponible'),
                    Justificacion: String(response.Justificacion || 'No disponible'),
                    Incumplimientos: typeof response.Incumplimientos === 'string' ? response.Incumplimientos : 
                        (Array.isArray(response.Incumplimientos) ? response.Incumplimientos.join('\n') : 'Ninguno'),
                    Recomendaciones: typeof response.Recomendaciones === 'string' ? response.Recomendaciones : 
                        (Array.isArray(response.Recomendaciones) ? response.Recomendaciones.join('\n') : 'Ninguna')
                };
                
            } catch (error) {
                console.error('Error analizando caso:', error);
                analysisResult = {
                    Resumen: `Error al analizar el caso: ${error.message}`,
                    Analisis: {
                        "ITL-1": "No disponible por error en an√°lisis",
                        "ITL-2": "No disponible por error en an√°lisis",
                        "ITL-3": "No disponible por error en an√°lisis", 
                        "ITL-4": "No disponible por error en an√°lisis",
                        "ITL-5": "No disponible por error en an√°lisis",
                        "ITL-T": "No disponible por error en an√°lisis"
                    },
                    Dictamen: "Suspensi√≥n",
                    Justificacion: `Error en el an√°lisis: ${error.message} (punto II.1.19 DTO-PACH-RL-03)`,
                    Incumplimientos: "Datos insuficientes para an√°lisis completo",
                    Recomendaciones: "Verificar calidad del PDF y recabar ITL completos y legibles"
                };
            }
        }

        // Funci√≥n para llamar a Azure OpenAI GPT-4o
        async function callAzureOpenAI(imageBase64, pageNum, mode, textPrompt) {
            const url = `${AZURE_CONFIG.endpoint}/openai/deployments/${AZURE_CONFIG.deployment}/chat/completions?api-version=${AZURE_CONFIG.apiVersion}`;
            let body;

            if (mode === 'extract') {
                const prompt = `
Eres un experto extrayendo datos de formularios ITL de PEMEX. Analiza esta imagen de forma exhaustiva y extrae TODA la informaci√≥n visible, incluyendo texto manuscrito y datos impresos.

IMPORTANTE: Busca informaci√≥n de UN SOLO TRABAJADOR por documento.

EXTRAE ESTOS CAMPOS SI EST√ÅN PRESENTES:
- Ficha (n√∫mero de empleado)
- Nombre (nombre completo del trabajador)
- Fecha_Incidente (cuando ocurri√≥ el accidente)
- Centro_Trabajo (lugar de trabajo)
- Departamento (√°rea de adscripci√≥n)
- Categoria (puesto del trabajador)
- Clave_Centro (c√≥digo del centro)
- Relato_Hechos (c√≥mo ocurri√≥ la lesi√≥n)
- Relato_Medico (descripci√≥n m√©dica)
- Medico (nombre del m√©dico)
- Fecha_Atencion (cuando se atendi√≥)
- Diagnostico (diagn√≥stico m√©dico)
- Unidad_Medica (hospital/cl√≠nica)
- Condiciones_Inseguras (condiciones peligrosas)
- Actos_Inseguros (acciones inseguras)
- Calificacion_Accidente (si es de trabajo o no)
- Fundamento_Legal (base legal)
- Costo_Total (costo de atenci√≥n)
- Tipo_Incapacidad (temporal, permanente, etc.)
- Dias_Incapacidad (d√≠as de incapacidad)

RESPONDE en JSON puro. Omite campos vac√≠os o no visibles. NO incluyas explicaciones adicionales.
`;
                body = {
                    messages: [
                        {
                            role: 'user',
                            content: [
                                { type: 'text', text: prompt },
                                { type: 'image_url', image_url: { url: `data:image/png;base64,${imageBase64}` } }
                            ]
                        }
                    ],
                    max_tokens: 3000,
                    temperature: 0.1
                };
            } else {
                body = {
                    messages: [
                        { role: 'user', content: textPrompt }
                    ],
                    max_tokens: 4000,
                    temperature: 0.2
                };
            }

            for (let attempt = 1; attempt <= 2; attempt++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'api-key': AZURE_CONFIG.apiKey
                        },
                        body: JSON.stringify(body)
                    });

                    if (!response.ok) {
                        throw new Error(`Azure OpenAI Error: ${response.status}`);
                    }

                    const result = await response.json();
                    const content = result.choices[0].message.content;
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        return JSON.parse(jsonMatch[0]);
                    }
                    return JSON.parse(content);
                } catch (error) {
                    console.error(`Intento ${attempt} fallido (modo ${mode}):`, error);
                    if (attempt === 2) {
                        return {};
                    }
                }
            }
            return {};
        }

        // Funci√≥n para corregir errores de OCR comunes
        function correctOCRText(text) {
            const corrections = {
                'Rasillo': 'Pasillo',
                'articulo': 'art√≠culo',
                'lesono': 'lesion√≥',
                'trabujador': 'trabajador',
                'h√©ber': 'haber',
                'oculrido': 'ocurrido',
                'evenly': 'evento',
                'caminanc': 'caminando',
                'irregularidadi': 'irregularidades',
                'pers': 'pero',
                'compafÃÉero': 'compa√±ero',
                'doetimento': 'documento',
                'Pesterament': 'Posteriormente',
                'olmica': 'cl√≠nica',
                'truslada': 'trasladan',
                'seucio': 'servicio',
                'Urgacion': 'Urgencias',
                'medico': 'm√©dico',
                'urgencyon': 'urgencias',
                '√âguince': 'Esguince',
                'caucal': 'codo',
                'primor quado': 'primer grado',
                'posturmentes': 'posteriormente',
                'Otop√©ta': 'Ortopedia',
                'valorandanes': 'valor√°ndome',
                'teche': 'fecha',
                'jefe': 'jefe',
                'acciante': 'accidente',
                'fuel': 'fue'
            };
            let corrected = text;
            for (const [wrong, right] of Object.entries(corrections)) {
                corrected = corrected.replace(new RegExp(wrong, 'gi'), right);
            }
            return corrected;
        }

        // Funci√≥n para mostrar resultado individual
        function displayResult() {
            const extractedDataDiv = document.getElementById('extractedData');
            const processStatus = document.getElementById('processStatus');
            const resultSection = document.getElementById('resultSection');

            extractedDataDiv.innerHTML = '';
            
            if (!analysisResult) {
                showStatus('No hay resultado para mostrar', 'error');
                return;
            }

            const caseName = caseData.Nombre || 'Caso Individual';
            const card = document.createElement('div');
            card.className = 'field-display p-6 rounded-lg';
            card.innerHTML = `
                <div class="text-blue-200 text-lg font-medium mb-2">üìã Caso: ${caseName}</div>
                <div class="text-white text-xl font-bold mb-3">Dictamen: ${analysisResult.Dictamen || 'No disponible'}</div>
                <div class="text-white text-base mb-4">${analysisResult.Resumen || 'Sin resumen'}</div>
                <button class="accordion-toggle text-blue-400 text-sm bg-blue-600 bg-opacity-20 px-4 py-2 rounded">Ver detalles completos</button>
                <div class="accordion-content">
                    <div class="mt-4 space-y-4">
                        <div class="bg-white bg-opacity-10 p-4 rounded">
                            <h4 class="text-blue-300 font-semibold mb-2">üìä An√°lisis por Formulario ITL:</h4>
                            <div class="text-white text-sm space-y-2">
                                ${Object.entries(analysisResult.Analisis || {})
                                    .filter(([_, value]) => value && value !== 'No disponible')
                                    .map(([key, value]) => `<div><strong class="text-blue-200">${key}:</strong> ${value}</div>`)
                                    .join('') || '<div>No hay an√°lisis detallado disponible</div>'}
                            </div>
                        </div>
                        <div class="bg-white bg-opacity-10 p-4 rounded">
                            <h4 class="text-blue-300 font-semibold mb-2">‚öñÔ∏è Justificaci√≥n Legal:</h4>
                            <div class="text-white text-sm">${analysisResult.Justificacion || 'No disponible'}</div>
                        </div>
                        <div class="bg-white bg-opacity-10 p-4 rounded">
                            <h4 class="text-blue-300 font-semibold mb-2">‚ö†Ô∏è Incumplimientos Detectados:</h4>
                            <div class="text-white text-sm">${analysisResult.Incumplimientos || 'Ninguno'}</div>
                        </div>
                        <div class="bg-white bg-opacity-10 p-4 rounded">
                            <h4 class="text-blue-300 font-semibold mb-2">üìã Recomendaciones:</h4>
                            <div class="text-white text-sm">${analysisResult.Recomendaciones || 'Ninguna'}</div>
                        </div>
                    </div>
                </div>
            `;
            extractedDataDiv.appendChild(card);

            card.querySelector('.accordion-toggle').addEventListener('click', () => {
                const content = card.querySelector('.accordion-content');
                content.classList.toggle('open');
                card.querySelector('.accordion-toggle').textContent = content.classList.contains('open') ? 'Ocultar detalles' : 'Ver detalles completos';
            });

            // Mostrar estado de formularios ITL
            const hasITL1 = caseData.Relato_Hechos && caseData.Relato_Hechos.length > 20;
            const hasITL2 = caseData.Relato_Medico || caseData.Medico || caseData.Diagnostico;
            const hasITL3 = caseData.Condiciones_Inseguras || caseData.Actos_Inseguros;
            const hasITL4 = caseData.Calificacion_Accidente;
            const hasITL5 = caseData.Costo_Total || caseData.Tipo_Incapacidad;
            const hasITLT = caseData.Es_Traslado;

            processStatus.innerHTML = `
                <div class="bg-white bg-opacity-10 p-4 rounded-lg">
                    <div class="text-white font-medium mb-3">Estado de Formularios ITL para: ${caseName}</div>
                    <div class="grid grid-cols-3 md:grid-cols-6 gap-2 text-center text-sm">
                        <div class="p-2 rounded ${hasITL1 ? 'bg-green-500 bg-opacity-20 text-green-300' : 'bg-red-500 bg-opacity-20 text-red-300'}">
                            <div class="font-semibold">ITL-1</div>
                            <div>${hasITL1 ? '‚úÖ' : '‚ùå'}</div>
                        </div>
                        <div class="p-2 rounded ${hasITL2 ? 'bg-green-500 bg-opacity-20 text-green-300' : 'bg-red-500 bg-opacity-20 text-red-300'}">
                            <div class="font-semibold">ITL-2</div>
                            <div>${hasITL2 ? '‚úÖ' : '‚ùå'}</div>
                        </div>
                        <div class="p-2 rounded ${hasITL3 ? 'bg-green-500 bg-opacity-20 text-green-300' : 'bg-red-500 bg-opacity-20 text-red-300'}">
                            <div class="font-semibold">ITL-3</div>
                            <div>${hasITL3 ? '‚úÖ' : '‚ùå'}</div>
                        </div>
                        <div class="p-2 rounded ${hasITL4 ? 'bg-green-500 bg-opacity-20 text-green-300' : 'bg-red-500 bg-opacity-20 text-red-300'}">
                            <div class="font-semibold">ITL-4</div>
                            <div>${hasITL4 ? '‚úÖ' : '‚ùå'}</div>
                        </div>
                        <div class="p-2 rounded ${hasITL5 ? 'bg-green-500 bg-opacity-20 text-green-300' : 'bg-red-500 bg-opacity-20 text-red-300'}">
                            <div class="font-semibold">ITL-5</div>
                            <div>${hasITL5 ? '‚úÖ' : '‚ùå'}</div>
                        </div>
                        <div class="p-2 rounded ${hasITLT ? 'bg-green-500 bg-opacity-20 text-green-300' : 'bg-yellow-500 bg-opacity-20 text-yellow-300'}">
                            <div class="font-semibold">ITL-T</div>
                            <div>${hasITLT ? '‚úÖ' : 'N/A'}</div>
                        </div>
                    </div>
                </div>
            `;

            resultSection.classList.remove('hidden');
        }

        // Funci√≥n para generar y descargar PDF
        function downloadPDF() {
            if (!analysisResult || !caseData) {
                showStatus('No hay datos para generar el PDF', 'error');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                const pageWidth = doc.internal.pageSize.width;
                const pageHeight = doc.internal.pageSize.height;
                const margin = 20;
                let yOffset = margin;

                const caseName = caseData.Nombre || 'Caso Individual';

                // Encabezado
                doc.setFontSize(16);
                doc.setTextColor(0, 48, 135); // Azul Pemex
                doc.text('DICTAMEN DE AN√ÅLISIS DE ACCIDENTE DE TRABAJO', pageWidth / 2, yOffset, { align: 'center' });
                yOffset += 8;
                
                doc.setFontSize(12);
                doc.text('PETR√ìLEOS MEXICANOS (PEMEX)', pageWidth / 2, yOffset, { align: 'center' });
                yOffset += 10;
                
                doc.setFontSize(10);
                doc.setTextColor(0);
                doc.text(`Fecha de emisi√≥n: 30 de mayo de 2025`, pageWidth / 2, yOffset, { align: 'center' });
                yOffset += 5;
                doc.text(`No. ITL-DICTAMEN-${currentAccidentId}`, pageWidth / 2, yOffset, { align: 'center' });
                yOffset += 15;

                // Datos del caso
                doc.setFontSize(12);
                doc.setTextColor(0, 48, 135);
                doc.text('DATOS DEL CASO', margin, yOffset);
                yOffset += 8;

                doc.setFontSize(10);
                doc.setTextColor(0);
                const basicInfo = [
                    `Trabajador: ${caseName}`,
                    `Ficha: ${caseData.Ficha || 'No disponible'}`,
                    `Centro de Trabajo: ${caseData.Centro_Trabajo || 'No especificado'}`,
                    `Departamento: ${caseData.Departamento || 'No especificado'}`,
                    `Categor√≠a: ${caseData.Categoria || 'No especificada'}`,
                    `Fecha del Incidente: ${caseData.Fecha_Incidente || 'No especificada'}`
                ];

                basicInfo.forEach(info => {
                    doc.text(info, margin, yOffset);
                    yOffset += 5;
                });
                yOffset += 5;

                // Resumen
                if (yOffset > pageHeight - margin - 20) {
                    doc.addPage();
                    yOffset = margin;
                }
                
                doc.setFontSize(12);
                doc.setTextColor(0, 48, 135);
                doc.text('RESUMEN DEL INCIDENTE', margin, yOffset);
                yOffset += 8;

                doc.setFontSize(10);
                doc.setTextColor(0);
                const resumenLines = doc.splitTextToSize(analysisResult.Resumen, pageWidth - 2 * margin);
                doc.text(resumenLines, margin, yOffset);
                yOffset += resumenLines.length * 5 + 10;

                // An√°lisis por formularios
                if (yOffset > pageHeight - margin - 30) {
                    doc.addPage();
                    yOffset = margin;
                }

                doc.setFontSize(12);
                doc.setTextColor(0, 48, 135);
                doc.text('AN√ÅLISIS POR FORMULARIOS ITL', margin, yOffset);
                yOffset += 8;

                const analysisItems = Object.entries(analysisResult.Analisis || {})
                    .filter(([_, value]) => value && value !== 'No disponible');

                if (analysisItems.length > 0) {
                    doc.autoTable({
                        startY: yOffset,
                        head: [['Formato', 'An√°lisis']],
                        body: analysisItems.map(([key, value]) => [key, value]),
                        theme: 'grid',
                        headStyles: { fillColor: [0, 48, 135], textColor: [255, 255, 255] },
                        margin: { left: margin, right: margin },
                        styles: { fontSize: 9, cellPadding: 3 },
                        columnStyles: { 0: { cellWidth: 25 }, 1: { cellWidth: pageWidth - 2 * margin - 25 } }
                    });
                    yOffset = doc.lastAutoTable.finalY + 10;
                } else {
                    doc.setFontSize(10);
                    doc.text('No se detectaron formularios ITL completos para an√°lisis detallado.', margin, yOffset);
                    yOffset += 10;
                }

                // Dictamen
                if (yOffset > pageHeight - margin - 30) {
                    doc.addPage();
                    yOffset = margin;
                }

                doc.setFontSize(12);
                doc.setTextColor(0, 48, 135);
                doc.text('DICTAMEN', margin, yOffset);
                yOffset += 8;

                doc.setFontSize(11);
                doc.setTextColor(0);
                doc.setFont(undefined, 'bold');
                doc.text(`CALIFICACI√ìN: ${analysisResult.Dictamen}`, margin, yOffset);
                doc.setFont(undefined, 'normal');
                yOffset += 10;

                // Justificaci√≥n
                doc.setFontSize(10);
                doc.setTextColor(0, 48, 135);
                doc.text('Justificaci√≥n Legal:', margin, yOffset);
                yOffset += 5;

                doc.setTextColor(0);
                const justificationLines = doc.splitTextToSize(analysisResult.Justificacion, pageWidth - 2 * margin);
                doc.text(justificationLines, margin, yOffset);
                yOffset += justificationLines.length * 5 + 10;

                // Incumplimientos
                if (yOffset > pageHeight - margin - 30) {
                    doc.addPage();
                    yOffset = margin;
                }

                doc.setFontSize(10);
                doc.setTextColor(0, 48, 135);
                doc.text('Incumplimientos Detectados:', margin, yOffset);
                yOffset += 5;

                doc.setTextColor(0);
                const incumplimientosLines = doc.splitTextToSize(analysisResult.Incumplimientos, pageWidth - 2 * margin);
                doc.text(incumplimientosLines, margin, yOffset);
                yOffset += incumplimientosLines.length * 5 + 10;

                // Recomendaciones
                if (yOffset > pageHeight - margin - 30) {
                    doc.addPage();
                    yOffset = margin;
                }

                doc.setFontSize(10);
                doc.setTextColor(0, 48, 135);
                doc.text('Recomendaciones:', margin, yOffset);
                yOffset += 5;

                doc.setTextColor(0);
                const recomendacionesLines = doc.splitTextToSize(analysisResult.Recomendaciones, pageWidth - 2 * margin);
                doc.text(recomendacionesLines, margin, yOffset);
                yOffset += recomendacionesLines.length * 5 + 15;

                // Firma
                if (yOffset > pageHeight - margin - 20) {
                    doc.addPage();
                    yOffset = margin;
                }

                doc.setFontSize(10);
                doc.setTextColor(0);
                doc.text('ELABORADO POR:', margin, yOffset);
                yOffset += 5;
                doc.text('Sistema ITL PEMEX', margin, yOffset);
                yOffset += 4;
                doc.text('An√°lisis Automatizado de Accidentes de Trabajo', margin, yOffset);
                yOffset += 4;
                doc.text('Conforme a DTO-PACH-RL-03', margin, yOffset);

                // Pie de p√°gina en todas las p√°ginas
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(100);
                    doc.text(`P√°gina ${i} de ${pageCount}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                    doc.text('Generado por Sistema ITL PEMEX - Conforme a normatividad vigente', pageWidth / 2, pageHeight - 5, { align: 'center' });
                }

                // Guardar PDF
                const fileName = `Dictamen_ITL_${caseName.replace(/\s+/g, '_')}_${currentAccidentId}_${new Date().toISOString().slice(0, 10)}.pdf`;
                doc.save(fileName);
                showStatus('‚úÖ PDF del dictamen generado y descargado exitosamente', 'success');

            } catch (error) {
                console.error('Error generando PDF:', error);
                showStatus(`‚ùå Error generando PDF: ${error.message}`, 'error');
            }
        }

        // Funci√≥n para mostrar estado
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            let className = 'mt-6 p-4 rounded-lg ';
            if (type === 'success') {
                className += 'bg-green-500 bg-opacity-20 text-green-300 border border-green-500 success-message';
            } else if (type === 'error') {
                className += 'bg-red-500 bg-opacity-20 text-red-300 border border-red-500';
            } else if (type === 'warning') {
                className += 'bg-yellow-500 bg-opacity-20 text-yellow-300 border border-yellow-500';
            } else {
                className += 'bg-blue-500 bg-opacity-20 text-blue-300 border border-blue-500';
            }
            status.className = className;
            status.classList.remove('hidden');
        }

        // Funci√≥n para mostrar ayuda
        function showHelp() {
            const helpContent = `
                <div class="bg-blue-900 bg-opacity-30 p-6 rounded-xl max-w-2xl">
                    <h3 class="text-xl font-bold text-white mb-4">üìö Ayuda del Sistema ITL</h3>
                    <div class="space-y-4 text-white">
                        <div>
                            <h4 class="font-semibold text-blue-200">üîç An√°lisis Individual:</h4>
                            <p class="text-sm">Analiza UN SOLO caso por PDF conforme a DTO-PACH-RL-03.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold text-blue-200">üìÑ Proceso:</h4>
                            <p class="text-sm">1. Sube PDF con informaci√≥n de una persona<br>
                            2. El sistema extrae y analiza los datos<br>
                            3. Genera dictamen basado en normatividad PEMEX</p>
                        </div>
                        <div>
                            <h4 class="font-semibold text-blue-200">‚ö†Ô∏è Importante:</h4>
                            <p class="text-sm">Cada PDF debe contener informaci√≥n de UNA SOLA PERSONA para garantizar an√°lisis preciso.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold text-blue-200">üîí Seguridad:</h4>
                            <p class="text-sm">Procesamiento con Azure OpenAI, datos seguros.</p>
                        </div>
                    </div>
                    <button onclick="this.parentElement.parentElement.style.display='none'" 
                            class="mt-4 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-white">
                        Cerrar Ayuda
                    </button>
                </div>
            `;
            const helpDiv = document.createElement('div');
            helpDiv.innerHTML = helpContent;
            helpDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            helpDiv.onclick = function(e) {
                if (e.target === helpDiv) {
                    document.body.removeChild(helpDiv);
                }
            };
            document.body.appendChild(helpDiv);
        }

        // Agregar bot√≥n de ayuda
        document.addEventListener('DOMContentLoaded', function() {
            const helpButton = document.createElement('button');
            helpButton.className = 'fixed bottom-4 right-4 bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-full shadow-lg z-40';
            helpButton.innerHTML = '‚ùì';
            helpButton.onclick = showHelp;
            helpButton.title = 'Ayuda del Sistema';
            document.body.appendChild(helpButton);
        });
    </script>
</body>
</html>
